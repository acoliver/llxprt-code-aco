# Phase 08: Integration Implementation

## Phase ID
`PLAN-20251023-STATELESS-HARDENING.P08`

## Prerequisites
- Required: `.completed/P07a.md` recorded.
- Verification: `test -f project-plans/20251023stateless4/.completed/P07a.md`
- Expected files from previous phase: Failing integration tests documenting stateless provider issues.

## Implementation Tasks

### Provider Files to Modify
- `packages/core/src/providers/anthropic/AnthropicProvider.ts`
  - Remove client/runtime caches and resolve clients per call using normalized options (pseudocode lines 10-14 in `provider-cache-elimination.md`, REQ-SP4-002/003).
  - Eliminate constructor-captured `config`/user-memory accessors, pulling `config.getUserMemory()` inside each call per pseudocode line 13 in `analysis/pseudocode/provider-runtime-handling.md` (@plan:PLAN-20251023-STATELESS-HARDENING.P08, @requirement:REQ-SP4-003).
- `packages/core/src/providers/openai/OpenAIProvider.ts`
  - Eliminate `modelParams` persistence; compute from options/config each call (pseudocode lines 10-14, REQ-SP4-002/003).
  - Replace any stored config references with per-invocation reads of normalized `config` helpers (pseudocode line 13, @plan:PLAN-20251023-STATELESS-HARDENING.P08, @requirement:REQ-SP4-003).
- `packages/core/src/providers/openai-responses/OpenAIResponsesProvider.ts`
  - Replace runtime scope cache with per-call context; ensure conversation state isolated (pseudocode lines 10-14).
  - Remove constructor defaults for `config`/user-memory and wire all conversation helpers to call-scoped values (pseudocode line 13, @plan:PLAN-20251023-STATELESS-HARDENING.P08, @requirement:REQ-SP4-003).
- `packages/core/src/providers/gemini/GeminiProvider.ts`
  - Remove `currentModel`, `modelParams`, and auth caches; rely on normalized options (pseudocode lines 11-14).
- `packages/core/src/providers/LoggingProviderWrapper.ts`
  - Inject runtime settings/config per call instead of constructor capture (pseudocode lines 10-14 in `logging-wrapper-adjustments.md`, REQ-SP4-004).
- `packages/core/src/providers/ProviderManager.ts`
  - Push call-scoped context into wrapper and providers (pseudocode line 11 from `provider-runtime-handling.md`).

### CLI Runtime Files to Modify
- `packages/cli/src/runtime/runtimeSettings.ts`
  - Ensure runtime services push validated context into ProviderManager per call (pseudocode lines 10-16 from `provider-runtime-handling.md`, REQ-SP4-004/005).
- `packages/cli/src/runtime/runtimeSettings.test.ts`
  - Update/extend tests to assert multi-runtime registry continues to function with new guard behaviour (integration requirement).
- `packages/cli/src/runtime/__tests__/runtimeIsolation.test.ts`
  - Add scenarios verifying providers throw meaningful errors if runtime not initialised, and that isolation holds with stateless providers.
- `packages/cli/src/runtime/__tests__/profileApplication.test.ts`
  - Confirm profile application uses call-scoped settings/config without touching singletons.

### Activities
- Ensure each provider obtains model/baseURL/auth from `NormalizedGenerateChatOptions` generated by BaseProvider guard.
- Strip constructor-captured accessors (`this.config`, memoized user-memory readers) and pivot to call-scoped data surfaces referenced in pseudocode line 13.
- Replace module-level caches with ephemeral structures (if necessary) scoped within method invocation.
- Update instrumentation/tracking to reference new data flow without storing state on instances.
- Update CLI runtime helpers to call the new ProviderManager APIs and remove legacy singleton fallbacks.
- Update integration tests from P07 to pass by aligning implementation with expected behaviour.

### Required Code Markers
- Each modified location must contain comment block referencing `@plan:PLAN-20251023-STATELESS-HARDENING.P08`, relevant `@requirement:REQ-SP4-00X` IDs, and pseudocode line ranges.

## Verification Commands

### Automated Checks
```bash
pnpm test --filter "stateless" --runInBand
pnpm test --filter "LoggingProviderWrapper" --runInBand
pnpm test --filter "runtime" --runInBand
pnpm lint providers --filter "providers"
```

### Manual Verification Checklist
- [ ] All statelessness tests from P07 now pass.
- [ ] Anthropic and OpenAI Responses providers read `config`/user-memory exclusively from the current call context (validated via updated tests and code review).
- [ ] No provider retains mutable fields for model/params/auth between calls.
- [ ] Logging wrapper no longer stores constructor config; accepts call-scoped data.
- [ ] CLI runtime isolation/profile tests pass with the new wiring and surface actionable errors when runtimes are missing.

## Success Criteria
- Providers behave as pure functions of invocation context and CLI runtime consumers propagate stateless context without regressions.

## Failure Recovery
1. If tests still fail, inspect normalized options flow and adjust provider implementations accordingly.
2. Validate removal of caches does not introduce performance regressions; adjust design if necessary.

## Phase Completion Marker
- Create `.completed/P08.md` capturing timestamp, files touched, and test/lint output per PLAN-TEMPLATE guidelines.
