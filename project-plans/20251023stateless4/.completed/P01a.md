# PLAN-20251023-STATELESS-HARDENING.P01a Completion
Start: 2025-10-23T16:44:53-0300
End: 2025-10-23T16:52:32-0300

## Summary
- Updated analysis/domain-model.md with runtime instrumentation drift scenario and requirement traceability for REQ-SP4-004/REQ-SP4-005.
- Refreshed verification checklists across analysis/verification/*.md to capture @plan markers and confirm REQ-SP4-001..005 coverage.
- Requirement coverage loop executed via zsh; output captured below for audit.

## Requirement Coverage Output
```text
project-plans/20251023stateless4/analysis/pseudocode/base-provider-fallback-removal.md:> Requirements: @requirement:REQ-SP4-001, @requirement:REQ-SP4-002
project-plans/20251023stateless4/analysis/pseudocode/base-provider-fallback-removal.md:11: When resolving settings, check `options.settings`; if missing, throw `MissingProviderRuntimeError` referencing @requirement:REQ-SP4-001.
project-plans/20251023stateless4/analysis/pseudocode/base-provider-fallback-removal.md:12: Disallow fallback to `peekActiveProviderRuntimeContext` / `getSettingsService()`; instead use injected runtime context only when explicitly provided to satisfy @plan:PLAN-20251023-STATELESS-HARDENING.P05 and @requirement:REQ-SP4-001.
project-plans/20251023stateless4/analysis/pseudocode/base-provider-fallback-removal.md:<!-- @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-001 @requirement:REQ-SP4-002 -->
project-plans/20251023stateless4/analysis/domain-model.md:<!-- @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-001 @requirement:REQ-SP4-002 @requirement:REQ-SP4-003 -->
project-plans/20251023stateless4/analysis/domain-model.md:- **Singleton fallback (REQ-SP4-001)**: When `ProviderManager` is constructed without an explicit runtime (e.g., CLI background tasks instantiating `new ProviderManager()` in `packages/cli/src/runtime/runtimeSettings.ts:54-92`), `resolveInit()` (packages/core/src/providers/ProviderManager.ts:75-117) pulls from `getActiveProviderRuntimeContext()`. The subsequent call into `BaseProvider.resolveSettingsService()` (packages/core/src/providers/BaseProvider.ts:96-129) then uses the cached singleton `defaultSettingsService`, leaking credentials between runtimes.
project-plans/20251023stateless4/analysis/domain-model.md:<!-- @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-001 -->
project-plans/20251023stateless4/analysis/domain-model.md:4. Completion succeeds using global credentials, masking isolation gaps and violating REQ-SP4-001 expectations that missing runtime settings should hard fail.
project-plans/20251023stateless4/analysis/domain-model.md:- BaseProvider fallback enables leak from global singleton into runtimes (violates REQ-SP4-001, REQ-SP4-003).
project-plans/20251023stateless4/analysis/domain-model.md:<!-- @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-001 @requirement:REQ-SP4-002 @requirement:REQ-SP4-003 @requirement:REQ-SP4-004 @requirement:REQ-SP4-005 -->
project-plans/20251023stateless4/analysis/domain-model.md:| Missing fallback guard triggers CLI command crashes | REQ-SP4-001 | User-perceived outage when runtime setup skipped | Add explicit error path + CLI preflight check for `settings` injection |
project-plans/20251023stateless4/analysis/verification/base-provider-fallback-removal.md:- Ensure unit tests simulate missing `settings` to trigger explicit error for REQ-SP4-001.
project-plans/20251023stateless4/analysis/verification/base-provider-fallback-removal.md:<!-- @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-001 @requirement:REQ-SP4-002 -->
project-plans/20251023stateless4/analysis/verification/base-provider-fallback-removal.md:- Debug replay from `packages/core/src/providers/BaseProvider.ts:96-133` currently shows fallback to `getSettingsService()`; post-fix trace must emit `MissingProviderRuntimeError` with runtime id when `settings` absent, confirming REQ-SP4-001.
project-plans/20251023stateless4/analysis/verification/base-provider-fallback-removal.md:- [x] Domain model `Runtime ↔ Provider Interaction Failures` documents the singleton fallback leak with explicit BaseProvider/ProviderManager paths, covering @requirement:REQ-SP4-001 and @requirement:REQ-SP4-002. @plan:PLAN-20251023-STATELESS-HARDENING.P01
project-plans/20251023stateless4/analysis/verification/base-provider-fallback-removal.md:- [x] Pseudocode lines 10-14 retain the `MissingProviderRuntimeError` enforcement without conflicting assumptions; no additional corrections required. @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-001
project-plans/20251023stateless4/analysis/pseudocode/provider-cache-elimination.md:> Requirements: @requirement:REQ-SP4-002, @requirement:REQ-SP4-003
project-plans/20251023stateless4/analysis/pseudocode/provider-cache-elimination.md:12: Compute model parameters from `options.config.getEphemeralSettings()` / `options.settings.getProviderSettings()` at call time, aligning with @requirement:REQ-SP4-002.
project-plans/20251023stateless4/analysis/pseudocode/provider-cache-elimination.md:<!-- @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-002 @requirement:REQ-SP4-003 -->
project-plans/20251023stateless4/analysis/pseudocode/base-provider-fallback-removal.md:> Requirements: @requirement:REQ-SP4-001, @requirement:REQ-SP4-002
project-plans/20251023stateless4/analysis/pseudocode/base-provider-fallback-removal.md:14: Update auth/token retrieval to rely on validated runtime context; propagate errors upward without substituting defaults (feeds @plan:PLAN-20251023-STATELESS-HARDENING.P08 integration and @requirement:REQ-SP4-002).
project-plans/20251023stateless4/analysis/pseudocode/base-provider-fallback-removal.md:<!-- @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-001 @requirement:REQ-SP4-002 -->
project-plans/20251023stateless4/analysis/pseudocode/provider-runtime-handling.md:> Requirements: @requirement:REQ-SP4-002, @requirement:REQ-SP4-003, @requirement:REQ-SP4-005
project-plans/20251023stateless4/analysis/pseudocode/provider-runtime-handling.md:16: Provide explicit error when normalization fails (e.g., missing resolved auth or user memory resolver) referencing @requirement:REQ-SP4-002 / @requirement:REQ-SP4-003 to guide `@plan:PLAN-20251023-STATELESS-HARDENING.P08a` verification steps and `@plan:PLAN-20251023-STATELESS-HARDENING.P08` integration.
project-plans/20251023stateless4/analysis/pseudocode/provider-runtime-handling.md:<!-- @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-002 @requirement:REQ-SP4-003 @requirement:REQ-SP4-005 -->
project-plans/20251023stateless4/analysis/verification/logging-wrapper-adjustments.md:<!-- @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-002 @requirement:REQ-SP4-004 -->
project-plans/20251023stateless4/analysis/verification/logging-wrapper-adjustments.md:- Telemetry replay from `logConversationRequest` currently omits runtime identifiers; ensure new instrumentation attaches `runtimeId` sourced from per-call options so CLI logs demonstrate correct provider isolation for REQ-SP4-002.
project-plans/20251023stateless4/analysis/verification/provider-cache-elimination.md:<!-- @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-002 @requirement:REQ-SP4-003 -->
project-plans/20251023stateless4/analysis/verification/provider-cache-elimination.md:- Code review identified module-level caches at `OpenAIProvider.ts:49-70`, `AnthropicProvider.ts:28-51`, and `GeminiProvider.ts:46-78`; success requires these declarations disappear or become factory-scoped with runtime keys derived from call options, confirming REQ-SP4-002.
project-plans/20251023stateless4/analysis/verification/provider-cache-elimination.md:- [x] Confirmed domain model references for cache reuse include OAuth leakage scenario, keeping @requirement:REQ-SP4-002 and @requirement:REQ-SP4-003 highlighted for remediation. @plan:PLAN-20251023-STATELESS-HARDENING.P01
project-plans/20251023stateless4/analysis/verification/base-provider-fallback-removal.md:<!-- @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-001 @requirement:REQ-SP4-002 -->
project-plans/20251023stateless4/analysis/verification/base-provider-fallback-removal.md:- Integration harness `packages/cli/src/runtime/runtimeSettings.test.ts` should log `active runtime context required` when invoking without `activateIsolatedRuntimeContext`, matching REQ-SP4-002 guard expectations.
project-plans/20251023stateless4/analysis/verification/base-provider-fallback-removal.md:- [x] Domain model `Runtime ↔ Provider Interaction Failures` documents the singleton fallback leak with explicit BaseProvider/ProviderManager paths, covering @requirement:REQ-SP4-001 and @requirement:REQ-SP4-002. @plan:PLAN-20251023-STATELESS-HARDENING.P01
project-plans/20251023stateless4/analysis/verification/provider-runtime-handling.md:<!-- @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-002 @requirement:REQ-SP4-003 @requirement:REQ-SP4-005 -->
project-plans/20251023stateless4/analysis/verification/provider-runtime-handling.md:- Confirm CLI runtime registry tests call `resetCliProviderInfrastructure` and observe fresh `ProviderManager` instances without shared `settingsService`, demonstrating compliant call-scoped context under REQ-SP4-002/003.
project-plans/20251023stateless4/analysis/verification/provider-runtime-handling.md:- [x] Pseudocode steps 10-16 align with per-call normalization and explicit error handling; no additional edits required. @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-002 @requirement:REQ-SP4-003
project-plans/20251023stateless4/analysis/domain-model.md:<!-- @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-001 @requirement:REQ-SP4-002 @requirement:REQ-SP4-003 -->
project-plans/20251023stateless4/analysis/domain-model.md:- **Call-scope deficit (REQ-SP4-002)**: `LoggingProviderWrapper` retains constructor `config` (packages/core/src/providers/LoggingProviderWrapper.ts:41-84) and forwards it unchanged, so when an isolated runtime omits `config` in `GenerateChatOptions`, a new completion reuses stale models/base URLs, bypassing the call-scoped normalization expected by providers such as `OpenAIProvider` (packages/core/src/providers/openai/OpenAIProvider.ts:360-418).
project-plans/20251023stateless4/analysis/domain-model.md:<!-- @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-002 -->
project-plans/20251023stateless4/analysis/domain-model.md:3. `generateChatCompletion()` merges options with stale config, so `OpenAIProvider.createClient()` consumes outdated `baseURL` and `apiKey`, leading to misrouted requests and violating REQ-SP4-002.
project-plans/20251023stateless4/analysis/domain-model.md:- Provider caches (`runtimeClientCache`, `modelParams`, `currentModel`) persist beyond call; need call-scoped resolution (REQ-SP4-002).
project-plans/20251023stateless4/analysis/domain-model.md:<!-- @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-001 @requirement:REQ-SP4-002 @requirement:REQ-SP4-003 @requirement:REQ-SP4-004 @requirement:REQ-SP4-005 -->
project-plans/20251023stateless4/analysis/domain-model.md:| OAuth edge propagation through cached clients | REQ-SP4-002 & REQ-SP4-003 | Tokens leak across runtimes; potential unauthorized access | Purge module-level caches, bind tokens to call scope with `AsyncLocalStorage` |
project-plans/20251023stateless4/analysis/pseudocode/provider-cache-elimination.md:> Requirements: @requirement:REQ-SP4-002, @requirement:REQ-SP4-003
project-plans/20251023stateless4/analysis/pseudocode/provider-cache-elimination.md:13: Ensure OAuth/auth tokens derived via verified runtime context and not stored for reuse, meeting @requirement:REQ-SP4-003.
project-plans/20251023stateless4/analysis/pseudocode/provider-cache-elimination.md:<!-- @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-002 @requirement:REQ-SP4-003 -->
project-plans/20251023stateless4/analysis/pseudocode/provider-runtime-handling.md:> Requirements: @requirement:REQ-SP4-002, @requirement:REQ-SP4-003, @requirement:REQ-SP4-005
project-plans/20251023stateless4/analysis/pseudocode/provider-runtime-handling.md:13: For each invocation, pull `config` and `userMemory` from the normalized options rather than provider constructors (`@requirement:REQ-SP4-003`); this feeds red/green expectations in `@plan:PLAN-20251023-STATELESS-HARDENING.P07` and `@plan:PLAN-20251023-STATELESS-HARDENING.P08`.
project-plans/20251023stateless4/analysis/pseudocode/provider-runtime-handling.md:16: Provide explicit error when normalization fails (e.g., missing resolved auth or user memory resolver) referencing @requirement:REQ-SP4-002 / @requirement:REQ-SP4-003 to guide `@plan:PLAN-20251023-STATELESS-HARDENING.P08a` verification steps and `@plan:PLAN-20251023-STATELESS-HARDENING.P08` integration.
project-plans/20251023stateless4/analysis/pseudocode/provider-runtime-handling.md:<!-- @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-002 @requirement:REQ-SP4-003 @requirement:REQ-SP4-005 -->
project-plans/20251023stateless4/analysis/verification/provider-cache-elimination.md:<!-- @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-002 @requirement:REQ-SP4-003 -->
project-plans/20251023stateless4/analysis/verification/provider-cache-elimination.md:- Capture isolation regression test that alternates runtime IDs within `packages/core/src/providers/__tests__/providerIsolation.test.ts` (to be authored) and ensure captured logs record distinct OAuth tokens per call, satisfying REQ-SP4-003.
project-plans/20251023stateless4/analysis/verification/provider-cache-elimination.md:- [x] Confirmed domain model references for cache reuse include OAuth leakage scenario, keeping @requirement:REQ-SP4-002 and @requirement:REQ-SP4-003 highlighted for remediation. @plan:PLAN-20251023-STATELESS-HARDENING.P01
project-plans/20251023stateless4/analysis/verification/provider-cache-elimination.md:- [x] Pseudocode steps 10-14 mandate per-call client creation and token derivation; no conflicting notes detected. @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-003
project-plans/20251023stateless4/analysis/verification/provider-runtime-handling.md:- Integration tests validate `LoggingProviderWrapper` pushes runtime context per invocation (REQ-SP4-003, REQ-SP4-004).
project-plans/20251023stateless4/analysis/verification/provider-runtime-handling.md:<!-- @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-002 @requirement:REQ-SP4-003 @requirement:REQ-SP4-005 -->
project-plans/20251023stateless4/analysis/verification/provider-runtime-handling.md:- [x] Pseudocode steps 10-16 align with per-call normalization and explicit error handling; no additional edits required. @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-002 @requirement:REQ-SP4-003
project-plans/20251023stateless4/analysis/domain-model.md:<!-- @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-001 @requirement:REQ-SP4-002 @requirement:REQ-SP4-003 -->
project-plans/20251023stateless4/analysis/domain-model.md:- **Provider cache reuse (REQ-SP4-003)**: Concrete providers rely on module-level caches (`runtimeClientCache`, `modelParams`, `currentModel`) declared at top-level (e.g., `OpenAIProvider.ts:49-70`, `AnthropicProvider.ts:28-51`, `GeminiProvider.ts:46-78`). When a runtime without OAuth tokens invokes the provider after an OAuth-enabled session, the cached client carries the prior token and sidesteps new runtime configuration, causing auth mismatches.
project-plans/20251023stateless4/analysis/domain-model.md:<!-- @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-003 -->
project-plans/20251023stateless4/analysis/domain-model.md:3. Subsequent CLI invocation without OAuth context retrieves the cached client/token, bypassing `AuthPrecedenceResolver` and failing REQ-SP4-003 expectations for per-call token derivation.
project-plans/20251023stateless4/analysis/domain-model.md:- BaseProvider fallback enables leak from global singleton into runtimes (violates REQ-SP4-001, REQ-SP4-003).
project-plans/20251023stateless4/analysis/domain-model.md:<!-- @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-001 @requirement:REQ-SP4-002 @requirement:REQ-SP4-003 @requirement:REQ-SP4-004 @requirement:REQ-SP4-005 -->
project-plans/20251023stateless4/analysis/domain-model.md:| OAuth edge propagation through cached clients | REQ-SP4-002 & REQ-SP4-003 | Tokens leak across runtimes; potential unauthorized access | Purge module-level caches, bind tokens to call scope with `AsyncLocalStorage` |
project-plans/20251023stateless4/analysis/pseudocode/logging-wrapper-adjustments.md:> Requirements: @requirement:REQ-SP4-004, @requirement:REQ-SP4-005
project-plans/20251023stateless4/analysis/pseudocode/logging-wrapper-adjustments.md:13: Forward normalized options to wrapped provider, ensuring instrumentation updates include `@plan:PLAN-20251023-STATELESS-HARDENING.P08` and associated `@requirement:REQ-SP4-004` annotations.
project-plans/20251023stateless4/analysis/pseudocode/logging-wrapper-adjustments.md:<!-- @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-004 @requirement:REQ-SP4-005 -->
project-plans/20251023stateless4/analysis/verification/logging-wrapper-adjustments.md:- Confirm instrumentation references `@plan:PLAN-20251023-STATELESS-HARDENING.P08` and requirements `@requirement:REQ-SP4-004`.
project-plans/20251023stateless4/analysis/verification/logging-wrapper-adjustments.md:<!-- @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-002 @requirement:REQ-SP4-004 -->
project-plans/20251023stateless4/analysis/verification/logging-wrapper-adjustments.md:- Existing wrapper constructor signature `constructor(private readonly wrapped: IProvider, private readonly config: Config, ...)` (LoggingProviderWrapper.ts:58-66) confirms stale config capture; after refactor the config reference should be request-scoped and inspection of the compiled artifact must show no lingering `this.config` usage, validating REQ-SP4-004.
project-plans/20251023stateless4/analysis/verification/logging-wrapper-adjustments.md:- [x] Added runtime instrumentation drift scenario to `analysis/domain-model.md` covering wrapper reuse across resets, ensuring @requirement:REQ-SP4-004 and @requirement:REQ-SP4-005 remain in scope. @plan:PLAN-20251023-STATELESS-HARDENING.P01
project-plans/20251023stateless4/analysis/verification/logging-wrapper-adjustments.md:- [x] Pseudocode step 14 tracks teardown expectations so telemetry drops constructor state; no further adjustments needed. @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-004
project-plans/20251023stateless4/analysis/verification/provider-runtime-handling.md:- Integration tests validate `LoggingProviderWrapper` pushes runtime context per invocation (REQ-SP4-003, REQ-SP4-004).
project-plans/20251023stateless4/analysis/verification/provider-runtime-handling.md:- [x] Domain model now includes runtime instrumentation drift path, ensuring ProviderManager/reset scenarios surface REQ-SP4-004 and REQ-SP4-005 obligations for runtime handling. @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-005
project-plans/20251023stateless4/analysis/domain-model.md:- **Runtime instrumentation drift (REQ-SP4-004/REQ-SP4-005)**: `LoggingProviderWrapper` keeps constructor-supplied `config` and omits runtime identifiers when `ProviderManager.updateProviderWrapping()` (packages/core/src/providers/ProviderManager.ts:170-216) reuses the wrapper. During CLI resets via `resetCliProviderInfrastructure` (`packages/cli/src/runtime/runtimeSettings.ts:210-267`), telemetry still emits the old `runtimeId`, breaking isolation audits and hindering REQ-SP4-005 verification.
project-plans/20251023stateless4/analysis/domain-model.md:<!-- @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-004 @requirement:REQ-SP4-005 -->
project-plans/20251023stateless4/analysis/domain-model.md:3. `LoggingProviderWrapper.generateChatCompletion()` (packages/core/src/providers/LoggingProviderWrapper.ts:41-84) logs the stale `runtimeId` and `config`, masking the new runtime context and breaching REQ-SP4-004/REQ-SP4-005 auditing requirements.
project-plans/20251023stateless4/analysis/domain-model.md:- Logging wrapper/provider manager rely on constructor-config values (`this.config` captured once), leading to stale state when runtime switches (REQ-SP4-004) and preventing runtime reset paths from emitting fresh telemetry (REQ-SP4-005).
project-plans/20251023stateless4/analysis/domain-model.md:- Logging wrapper ensures each call passes `options.config` and `options.settings` explicitly to providers and emits per-call runtime metadata for telemetry compliance, satisfying @requirement:REQ-SP4-004 and @requirement:REQ-SP4-005 (requires wrapper/manager adjustments).
project-plans/20251023stateless4/analysis/domain-model.md:<!-- @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-001 @requirement:REQ-SP4-002 @requirement:REQ-SP4-003 @requirement:REQ-SP4-004 @requirement:REQ-SP4-005 -->
project-plans/20251023stateless4/analysis/domain-model.md:| CLI runtime registry regressions when resetting providers | REQ-SP4-004 & REQ-SP4-005 | Test harness fails to reinitialize logging + providers, breaking `resetCliProviderInfrastructure` | Provide explicit teardown hook and verify wrapper re-wraps using fresh config |
project-plans/20251023stateless4/analysis/pseudocode/logging-wrapper-adjustments.md:> Requirements: @requirement:REQ-SP4-004, @requirement:REQ-SP4-005
project-plans/20251023stateless4/analysis/pseudocode/logging-wrapper-adjustments.md:<!-- @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-004 @requirement:REQ-SP4-005 -->
project-plans/20251023stateless4/analysis/pseudocode/provider-runtime-handling.md:> Requirements: @requirement:REQ-SP4-002, @requirement:REQ-SP4-003, @requirement:REQ-SP4-005
project-plans/20251023stateless4/analysis/pseudocode/provider-runtime-handling.md:<!-- @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-002 @requirement:REQ-SP4-003 @requirement:REQ-SP4-005 -->
project-plans/20251023stateless4/analysis/pseudocode/provider-runtime-handling.md:- Open question: Should normalization provide default `userMemory` stubs for providers lacking feature support, or must callers supply explicit ability lists per REQ-SP4-005?
project-plans/20251023stateless4/analysis/verification/logging-wrapper-adjustments.md:- [x] Added runtime instrumentation drift scenario to `analysis/domain-model.md` covering wrapper reuse across resets, ensuring @requirement:REQ-SP4-004 and @requirement:REQ-SP4-005 remain in scope. @plan:PLAN-20251023-STATELESS-HARDENING.P01
project-plans/20251023stateless4/analysis/verification/provider-runtime-handling.md:<!-- @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-002 @requirement:REQ-SP4-003 @requirement:REQ-SP4-005 -->
project-plans/20251023stateless4/analysis/verification/provider-runtime-handling.md:- Trace `ProviderManager.updateProviderWrapping()` (ProviderManager.ts:170-216) to ensure new implementation pushes runtime context before invoking the wrapped provider; instrumentation should expose `runtimeId` in `logProviderSwitch`, aligning with REQ-SP4-005.
project-plans/20251023stateless4/analysis/verification/provider-runtime-handling.md:- [x] Domain model now includes runtime instrumentation drift path, ensuring ProviderManager/reset scenarios surface REQ-SP4-004 and REQ-SP4-005 obligations for runtime handling. @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-005
project-plans/20251023stateless4/analysis/domain-model.md:- **Runtime instrumentation drift (REQ-SP4-004/REQ-SP4-005)**: `LoggingProviderWrapper` keeps constructor-supplied `config` and omits runtime identifiers when `ProviderManager.updateProviderWrapping()` (packages/core/src/providers/ProviderManager.ts:170-216) reuses the wrapper. During CLI resets via `resetCliProviderInfrastructure` (`packages/cli/src/runtime/runtimeSettings.ts:210-267`), telemetry still emits the old `runtimeId`, breaking isolation audits and hindering REQ-SP4-005 verification.
project-plans/20251023stateless4/analysis/domain-model.md:<!-- @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-004 @requirement:REQ-SP4-005 -->
project-plans/20251023stateless4/analysis/domain-model.md:3. `LoggingProviderWrapper.generateChatCompletion()` (packages/core/src/providers/LoggingProviderWrapper.ts:41-84) logs the stale `runtimeId` and `config`, masking the new runtime context and breaching REQ-SP4-004/REQ-SP4-005 auditing requirements.
project-plans/20251023stateless4/analysis/domain-model.md:- Logging wrapper/provider manager rely on constructor-config values (`this.config` captured once), leading to stale state when runtime switches (REQ-SP4-004) and preventing runtime reset paths from emitting fresh telemetry (REQ-SP4-005).
project-plans/20251023stateless4/analysis/domain-model.md:- CLI isolation tests rely on runtime registry; changes must preserve `resetCliProviderInfrastructure`, `activateIsolatedRuntimeContext`, etc. (REQ-SP4-005).
project-plans/20251023stateless4/analysis/domain-model.md:- Logging wrapper ensures each call passes `options.config` and `options.settings` explicitly to providers and emits per-call runtime metadata for telemetry compliance, satisfying @requirement:REQ-SP4-004 and @requirement:REQ-SP4-005 (requires wrapper/manager adjustments).
project-plans/20251023stateless4/analysis/domain-model.md:<!-- @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-001 @requirement:REQ-SP4-002 @requirement:REQ-SP4-003 @requirement:REQ-SP4-004 @requirement:REQ-SP4-005 -->
project-plans/20251023stateless4/analysis/domain-model.md:| CLI runtime registry regressions when resetting providers | REQ-SP4-004 & REQ-SP4-005 | Test harness fails to reinitialize logging + providers, breaking `resetCliProviderInfrastructure` | Provide explicit teardown hook and verify wrapper re-wraps using fresh config |
```

<!-- @plan:PLAN-20251023-STATELESS-HARDENING.P01a @requirement:REQ-SP4-001 REQ-SP4-002 REQ-SP4-003 REQ-SP4-004 REQ-SP4-005 -->
