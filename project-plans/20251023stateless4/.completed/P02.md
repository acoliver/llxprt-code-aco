# P02 Remediation Completion

- Phase: PLAN-20251023-STATELESS-HARDENING.P02
- Worker: P02-remediation
- Start: 2025-10-23T20:09:12Z
- Finish: 2025-10-23T20:14:49Z
- Status: Completed (remediation)

## Summary
- Expanded cross-cutting pseudocode to enforce stateless provider runtime validation, logging context isolation, and cache elimination.
- Documented requirement-linked guardrails, error messaging, and runtime scope management for downstream implementation phases.
- Captured assumptions and open questions for error taxonomy, runtime scope utilities, and cache eviction pathways.

## Verification
- `rg "PLAN-20251023-STATELESS-HARDENING" project-plans/20251023stateless4/analysis/pseudocode`
```text
project-plans/20251023stateless4/analysis/pseudocode/logging-wrapper-adjustments.md:> - @plan:PLAN-20251023-STATELESS-HARDENING.P06 (integration stub expectations)
project-plans/20251023stateless4/analysis/pseudocode/logging-wrapper-adjustments.md:> - @plan:PLAN-20251023-STATELESS-HARDENING.P07 (integration TDD)
project-plans/20251023stateless4/analysis/pseudocode/logging-wrapper-adjustments.md:> - @plan:PLAN-20251023-STATELESS-HARDENING.P08 (integration implementation)
project-plans/20251023stateless4/analysis/pseudocode/logging-wrapper-adjustments.md:> - @plan:PLAN-20251023-STATELESS-HARDENING.P08a (verification)
project-plans/20251023stateless4/analysis/pseudocode/logging-wrapper-adjustments.md:10: During wrapper construction, drop cached `config`/`settings` fields; retain only logger + metrics dependencies so instances remain stateless (@plan:PLAN-20251023-STATELESS-HARDENING.P06, @requirement:REQ-SP4-004).
project-plans/20251023stateless4/analysis/pseudocode/logging-wrapper-adjustments.md:11: On `generateChatCompletion` invocation, call `const runtimeScope = runtimeContextTracker.push(callId, normalizedOptions)`; if the push fails, throw `ProviderRuntimeScopeError("Unable to push runtime scope for callId=" + callId)` to block logging without context (@plan:PLAN-20251023-STATELESS-HARDENING.P07).
project-plans/20251023stateless4/analysis/pseudocode/logging-wrapper-adjustments.md:13: Wrap provider invocation with `logger.withContext(runtimeScope.telemetry, () => wrappedProvider.generateChatCompletion(mergedOptions))` so every log line includes runtime metadata demanded by @plan:PLAN-20251023-STATELESS-HARDENING.P08.
project-plans/20251023stateless4/analysis/pseudocode/logging-wrapper-adjustments.md:14: On stream or promise resolution, emit `logger.trace("stateless-runtime.complete", { callId, duration })`; on error, emit `logger.warn("stateless-runtime.error", { callId, requirement: "REQ-SP4-005", err })` before rethrowing to satisfy @plan:PLAN-20251023-STATELESS-HARDENING.P08a.
project-plans/20251023stateless4/analysis/pseudocode/logging-wrapper-adjustments.md:<!-- @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-004 @requirement:REQ-SP4-005 -->
project-plans/20251023stateless4/analysis/pseudocode/logging-wrapper-adjustments.md:- Assumption: A reusable `runtimeContextTracker` utility exists (or will be introduced in @plan:PLAN-20251023-STATELESS-HARDENING.P05) to coordinate push/pop semantics without deadlocks.
project-plans/20251023stateless4/analysis/pseudocode/provider-cache-elimination.md:> - @plan:PLAN-20251023-STATELESS-HARDENING.P06 (integration stub scaffolding)
project-plans/20251023stateless4/analysis/pseudocode/provider-cache-elimination.md:> - @plan:PLAN-20251023-STATELESS-HARDENING.P07 (integration TDD)
project-plans/20251023stateless4/analysis/pseudocode/provider-cache-elimination.md:> - @plan:PLAN-20251023-STATELESS-HARDENING.P08 (integration implementation)
project-plans/20251023stateless4/analysis/pseudocode/provider-cache-elimination.md:> - @plan:PLAN-20251023-STATELESS-HARDENING.P08a (verification)
project-plans/20251023stateless4/analysis/pseudocode/provider-cache-elimination.md:> - @plan:PLAN-20251023-STATELESS-HARDENING.P09 (cleanup)
project-plans/20251023stateless4/analysis/pseudocode/provider-cache-elimination.md:10: Audit every provider module (`openai`, `anthropic`, `gemini`, etc.) and delete module-level caches such as `runtimeClientCache`, `modelParams`, and `currentModel`; document removals inline with `(@plan:PLAN-20251023-STATELESS-HARDENING.P08)` to prove stateless readiness for @requirement:REQ-SP4-002.
project-plans/20251023stateless4/analysis/pseudocode/provider-cache-elimination.md:11: Introduce `buildProviderClient(providerName, resolved, telemetry)` that returns a fresh SDK client per call; construct inside the invocation path using `resolved.baseURL` and `resolved.authToken`, and forbid storing the instance on `this` (@plan:PLAN-20251023-STATELESS-HARDENING.P07, @requirement:REQ-SP4-003).
project-plans/20251023stateless4/analysis/pseudocode/provider-cache-elimination.md:12: Derive model parameters on demand via `const modelParams = options.config.getEphemeralSettings(providerName);` and attach them to the local call scope only; throwing `ProviderCacheError("Attempted to memoize model parameters for " + providerName)` if a provider tries to persist them (`@plan:PLAN-20251023-STATELESS-HARDENING.P05`).
project-plans/20251023stateless4/analysis/pseudocode/provider-cache-elimination.md:13: For OAuth/token flows, call `await resolved.authToken.provide()` each invocation; wrap in `try/catch` to surface `ProviderCacheError("Auth token unavailable for runtimeId=" + runtimeId + " (REQ-SP4-003).")` rather than falling back to stale cached tokens (@plan:PLAN-20251023-STATELESS-HARDENING.P08a).
project-plans/20251023stateless4/analysis/pseudocode/provider-cache-elimination.md:14: Verify streaming handlers reference only local variables (`const streamState = { ... }`); mutate provider fields triggers `throw new ProviderCacheError("Stateful field mutation detected in " + providerName)` so regression tests can assert the guard (@plan:PLAN-20251023-STATELESS-HARDENING.P09).
project-plans/20251023stateless4/analysis/pseudocode/provider-cache-elimination.md:15: Emit telemetry `telemetry.record("stateless-provider.call", { providerName, cacheEliminated: true })` for later analytics and to confirm shared caches are removed across providers (@plan:PLAN-20251023-STATELESS-HARDENING.P08).
project-plans/20251023stateless4/analysis/pseudocode/provider-cache-elimination.md:<!-- @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-002 @requirement:REQ-SP4-003 -->
project-plans/20251023stateless4/analysis/pseudocode/provider-cache-elimination.md:- Assumption: A shared `ProviderCacheError` class will be available to standardize enforcement messaging; otherwise we introduce it during @plan:PLAN-20251023-STATELESS-HARDENING.P05.
project-plans/20251023stateless4/analysis/pseudocode/base-provider-fallback-removal.md:> - @plan:PLAN-20251023-STATELESS-HARDENING.P03 (stub guard scaffolding)
project-plans/20251023stateless4/analysis/pseudocode/base-provider-fallback-removal.md:> - @plan:PLAN-20251023-STATELESS-HARDENING.P04 (guard TDD coverage)
project-plans/20251023stateless4/analysis/pseudocode/base-provider-fallback-removal.md:> - @plan:PLAN-20251023-STATELESS-HARDENING.P05 (guard implementation)
project-plans/20251023stateless4/analysis/pseudocode/base-provider-fallback-removal.md:> - @plan:PLAN-20251023-STATELESS-HARDENING.P05a (guard verification)
project-plans/20251023stateless4/analysis/pseudocode/base-provider-fallback-removal.md:10: Accept `options: NormalizedGenerateChatOptions` from the provider manager and enter `runtimeContextStorage.run(options, ...)` to scope state per call (@plan:PLAN-20251023-STATELESS-HARDENING.P03, @plan:PLAN-20251023-STATELESS-HARDENING.P05) satisfying isolation mandated by @requirement:REQ-SP4-001.
project-plans/20251023stateless4/analysis/pseudocode/base-provider-fallback-removal.md:11: Invoke `assertRuntimeContext(options, providerName)`; if `!options?.settings`, throw `MissingProviderRuntimeError("BaseProvider.<providerName> requires ProviderManager-injected settings (@requirement:REQ-SP4-001).")` before any provider logic executes (@plan:PLAN-20251023-STATELESS-HARDENING.P05a).
project-plans/20251023stateless4/analysis/pseudocode/base-provider-fallback-removal.md:12: Within `assertRuntimeContext`, verify `options.config` is defined; on failure throw `MissingProviderRuntimeError("BaseProvider.<providerName> missing normalized config; disable legacy getSettingsService fallback (@plan:PLAN-20251023-STATELESS-HARDENING.P05).")` to prevent silent fallbacks and align with @requirement:REQ-SP4-001.
project-plans/20251023stateless4/analysis/pseudocode/base-provider-fallback-removal.md:13: Confirm `options.resolved` includes `model`, `baseURL`, and `authToken`; when absent, raise `ProviderRuntimeValidationError("Provider runtime incomplete for <providerName>; expected resolved.authToken/model/baseURL.", { requirement: "REQ-SP4-002" })` so downstream phases can assert correct messaging (@plan:PLAN-20251023-STATELESS-HARDENING.P07).
project-plans/20251023stateless4/analysis/pseudocode/base-provider-fallback-removal.md:14: Return `{ settings, config, resolved, telemetry, metadata }` from `assertRuntimeContext` and hand the tuple to provider implementations, ensuring every consumer references the validated structure instead of deprecated globals (@plan:PLAN-20251023-STATELESS-HARDENING.P05).
project-plans/20251023stateless4/analysis/pseudocode/base-provider-fallback-removal.md:15: Remove all usage of `peekActiveProviderRuntimeContext`, `getSettingsService()`, and other ambient read paths; the only runtime data source must be the verified tuple passed into the call scope (@plan:PLAN-20251023-STATELESS-HARDENING.P05, @requirement:REQ-SP4-001).
project-plans/20251023stateless4/analysis/pseudocode/base-provider-fallback-removal.md:16: When deriving auth credentials, call `context.resolved.authToken.get()` (or equivalent) and bubble the explicit error `ProviderRuntimeValidationError("Auth token resolver unavailable in stateless mode.")` instead of substituting defaults, ensuring @requirement:REQ-SP4-002 coverage and supporting @plan:PLAN-20251023-STATELESS-HARDENING.P08 checks.
project-plans/20251023stateless4/analysis/pseudocode/base-provider-fallback-removal.md:17: After provider execution, exit the `runtimeContextStorage` scope (`runtimeContextStorage.disable()` or implicit promise resolution) so subsequent calls start without residual context, preventing fallback leakage verified in @plan:PLAN-20251023-STATELESS-HARDENING.P08a.
project-plans/20251023stateless4/analysis/pseudocode/base-provider-fallback-removal.md:<!-- @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-001 @requirement:REQ-SP4-002 -->
project-plans/20251023stateless4/analysis/pseudocode/base-provider-fallback-removal.md:- Assumption: `MissingProviderRuntimeError` and `ProviderRuntimeValidationError` already exist (or can be extended) within the shared provider error module; otherwise we will extend the taxonomy during @plan:PLAN-20251023-STATELESS-HARDENING.P05.
project-plans/20251023stateless4/analysis/pseudocode/provider-runtime-handling.md:> - @plan:PLAN-20251023-STATELESS-HARDENING.P02 (pseudocode authoring)
project-plans/20251023stateless4/analysis/pseudocode/provider-runtime-handling.md:> - @plan:PLAN-20251023-STATELESS-HARDENING.P03-P05 (guard scaffolding and implementation)
project-plans/20251023stateless4/analysis/pseudocode/provider-runtime-handling.md:> - @plan:PLAN-20251023-STATELESS-HARDENING.P06 (integration stub scaffolding)
project-plans/20251023stateless4/analysis/pseudocode/provider-runtime-handling.md:> - @plan:PLAN-20251023-STATELESS-HARDENING.P07 (integration TDD)
project-plans/20251023stateless4/analysis/pseudocode/provider-runtime-handling.md:> - @plan:PLAN-20251023-STATELESS-HARDENING.P08 (integration implementation)
project-plans/20251023stateless4/analysis/pseudocode/provider-runtime-handling.md:> - @plan:PLAN-20251023-STATELESS-HARDENING.P08a (verification and integration)
project-plans/20251023stateless4/analysis/pseudocode/provider-runtime-handling.md:10: On `ProviderManager.generateChatCompletion` entry, clone caller-provided `GenerateChatOptions` and push them through `normalizeRuntimeInputs(rawOptions)` before any provider code runs (@plan:PLAN-20251023-STATELESS-HARDENING.P02, @requirement:REQ-SP4-002).
project-plans/20251023stateless4/analysis/pseudocode/provider-runtime-handling.md:11: `normalizeRuntimeInputs` must require `runtimeContext.settings` and `runtimeContext.config`; if either missing, throw `ProviderRuntimeNormalizationError("ProviderManager requires call-scoped settings/config; legacy provider state is disabled.")` to block fallbacks (@plan:PLAN-20251023-STATELESS-HARDENING.P05, @requirement:REQ-SP4-002).
project-plans/20251023stateless4/analysis/pseudocode/provider-runtime-handling.md:12: Compose `normalized.resolved = { model, baseURL, authToken, telemetry }` using runtime helpers; when any field is undefined, surface `ProviderRuntimeNormalizationError("Incomplete runtime resolution (model/baseURL/authToken) for runtimeId=" + runtimeId)` tagged with @requirement:REQ-SP4-003 and recorded for @plan:PLAN-20251023-STATELESS-HARDENING.P07.
project-plans/20251023stateless4/analysis/pseudocode/provider-runtime-handling.md:13: Ensure `normalized.userMemory` and `normalized.metadata` derive from the runtime context payload instead of provider constructors; reject attempts to read `this.currentModel` by throwing `ProviderRuntimeNormalizationError("Stateless provider attempted to read deprecated instance fields.")` (@plan:PLAN-20251023-STATELESS-HARDENING.P05).
project-plans/20251023stateless4/analysis/pseudocode/provider-runtime-handling.md:14: Enter the provider call inside `runtimeScope.run(normalized, providerInvoker)` so `AsyncLocalStorage` resets per invocation and fulfills @requirement:REQ-SP4-005 with traceability to @plan:PLAN-20251023-STATELESS-HARDENING.P06.
project-plans/20251023stateless4/analysis/pseudocode/provider-runtime-handling.md:15: Within `providerInvoker`, destructure `const { settings, config, resolved, userMemory } = normalized;` and pass to the concrete provider; prohibit reading mutable manager state by lint guard hooks referenced in @plan:PLAN-20251023-STATELESS-HARDENING.P07 and @plan:PLAN-20251023-STATELESS-HARDENING.P08.
project-plans/20251023stateless4/analysis/pseudocode/provider-runtime-handling.md:16: After provider completion (success or error), execute `finally { runtimeScope.exit(); normalized.clearEphemeral?.(); }` to wipe shared references, preventing cross-call leakage mandated by @requirement:REQ-SP4-003 and verified in @plan:PLAN-20251023-STATELESS-HARDENING.P08a.
project-plans/20251023stateless4/analysis/pseudocode/provider-runtime-handling.md:17: Emit structured error logs `logRuntimeValidationFailure(err, runtimeId)` including requirement tags so verification harness can assert messaging and remediation guidance (@plan:PLAN-20251023-STATELESS-HARDENING.P08a, @requirement:REQ-SP4-002, @requirement:REQ-SP4-005).
project-plans/20251023stateless4/analysis/pseudocode/provider-runtime-handling.md:<!-- @plan:PLAN-20251023-STATELESS-HARDENING.P01 @requirement:REQ-SP4-002 @requirement:REQ-SP4-003 @requirement:REQ-SP4-005 -->
project-plans/20251023stateless4/analysis/pseudocode/provider-runtime-handling.md:- Assumption: `runtimeScope` helper exposes `run()` / `exit()` semantics compatible with `AsyncLocalStorage`; otherwise @plan:PLAN-20251023-STATELESS-HARDENING.P03 must introduce the abstraction.
```

<!-- @plan:PLAN-20251023-STATELESS-HARDENING.P02 @requirement:REQ-SP4-001 REQ-SP4-002 REQ-SP4-003 REQ-SP4-004 REQ-SP4-005 -->

