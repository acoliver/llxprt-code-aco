
> @vybestack/llxprt-code@0.5.0 test:ci
> cross-env NODE_OPTIONS=--max-old-space-size=6144 npm run test:ci --workspaces --if-present && npm run test:scripts


> @vybestack/llxprt-code-a2a-server@0.5.0 test:ci
> vitest run --coverage


 RUN  v3.2.4 /Users/acoliver/projects/llxprt-code/packages/a2a-server
      Coverage enabled with v8

 ✓ src/persistence/gcs.test.ts (10 tests) 13ms
stdout | src/agent/task.test.ts > Task > scheduleToolCalls should not modify the input requests array
[INFO] 2025-11-01 14:48:28.297 PM -- [Task] Scheduling batch of 1 tool calls.
[INFO] 2025-11-01 14:48:28.299 PM -- [Task] Scheduler tool calls updated:
{
  "0": "1 (error)"
}
[INFO] 2025-11-01 14:48:28.300 PM -- [Task] All tool calls completed by scheduler (batch):
{
  "0": "1"
}

stdout | src/agent/task.test.ts > Task > scheduleToolCalls should not modify the input requests array
[INFO] 2025-11-01 14:48:28.300 PM -- [Task] Scheduler tool calls updated:

 ✓ src/http/endpoints.test.ts (5 tests) 64ms
 ✓ src/agent/task.test.ts (1 test) 8ms
 ✓ src/http/app.test.ts (5 tests) 44ms

 Test Files  4 passed (4)
      Tests  21 passed (21)
   Start at  14:48:25
   Duration  3.38s (transform 1.14s, setup 0ms, collect 7.42s, tests 129ms, environment 2ms, prepare 775ms)

JUNIT report written to /Users/acoliver/projects/llxprt-code/packages/a2a-server/junit.xml
 % Coverage report from v8

> @vybestack/llxprt-code@0.5.0 test:ci
> npm run test:ci:covered && npm run test:ci:fast


> @vybestack/llxprt-code@0.5.0 test:ci:covered
> vitest run -c vitest.ci.covered.config.ts


 RUN  v3.2.4 /Users/acoliver/projects/llxprt-code/packages/cli
      Coverage enabled with v8

 ✓ src/ui/reducers/appReducer.test.ts (36 tests) 6ms

 Test Files  1 passed (1)
      Tests  36 passed (36)
   Start at  14:48:29
   Duration  1.47s (transform 67ms, setup 69ms, collect 33ms, tests 6ms, environment 469ms, prepare 104ms)

JUNIT report written to /Users/acoliver/projects/llxprt-code/packages/cli/junit.covered.xml
 % Coverage report from v8
-------------------|---------|----------|---------|---------|-------------------
File               | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s 
-------------------|---------|----------|---------|---------|-------------------
All files          |    6.54 |       40 |    6.25 |    6.54 |                   
 contexts          |       0 |        0 |       0 |       0 |                   
  ...chContext.tsx |       0 |        0 |       0 |       0 | 1-29              
  ...ssContext.tsx |       0 |        0 |       0 |       0 | 1-760             
  ...erContext.tsx |       0 |        0 |       0 |       0 | 1-120             
  ...owContext.tsx |       0 |        0 |       0 |       0 | 1-87              
  ...meContext.tsx |       0 |        0 |       0 |       0 | 1-203             
  ...onContext.tsx |       0 |        0 |       0 |       0 | 1-165             
  ...teContext.tsx |       0 |        0 |       0 |       0 | 1-61              
  ...gsContext.tsx |       0 |        0 |       0 |       0 | 1-20              
  ...ngContext.tsx |       0 |        0 |       0 |       0 | 1-22              
  TodoContext.tsx  |       0 |        0 |       0 |       0 | 1-33              
  TodoProvider.tsx |       0 |        0 |       0 |       0 | 1-105             
  ...llContext.tsx |       0 |        0 |       0 |       0 | 1-30              
  ...lProvider.tsx |       0 |        0 |       0 |       0 | 1-122             
  ...deContext.tsx |       0 |        0 |       0 |       0 | 1-89              
 reducers          |   77.87 |     90.9 |      50 |   77.87 |                   
  appReducer.ts    |     100 |      100 |     100 |     100 |                   
  ...ionReducer.ts |       0 |        0 |       0 |       0 | 1-52              
-------------------|---------|----------|---------|---------|-------------------

> @vybestack/llxprt-code@0.5.0 test:ci:fast
> vitest run -c vitest.ci.fast.config.ts


 RUN  v3.2.4 /Users/acoliver/projects/llxprt-code/packages/cli

 ✓ src/integration-tests/runtime-isolation.test.ts (11 tests) 13ms
 ✓ src/runtime/agentRuntimeAdapter.spec.ts (55 tests) 43ms
 ✓ src/nonInteractiveCli.test.ts (8 tests) 12ms
 ❯ src/auth/oauth-manager.spec.ts (23 tests | 2 failed) 28ms
   ✓ OAuthManager with OAuth Enablement and Lazy Authentication > Provider Registration > should register OAuth provider and make it available 2ms
   ✓ OAuthManager with OAuth Enablement and Lazy Authentication > Provider Registration > should register multiple providers independently 1ms
   ✓ OAuthManager with OAuth Enablement and Lazy Authentication > Provider Registration > should list registered providers in sorted order 1ms
   ✓ OAuthManager with OAuth Enablement and Lazy Authentication > OAuth Enablement Management > should toggle OAuth enablement without triggering auth flow 2ms
   ✓ OAuthManager with OAuth Enablement and Lazy Authentication > OAuth Enablement Management > should check OAuth enablement status without triggering auth 1ms
   ✓ OAuthManager with OAuth Enablement and Lazy Authentication > OAuth Enablement Management > should toggle OAuth enablement for multiple providers independently 1ms
   ✓ OAuthManager with OAuth Enablement and Lazy Authentication > Lazy Authentication Flow > should trigger OAuth flow lazily when token needed for API call 1ms
   ✓ OAuthManager with OAuth Enablement and Lazy Authentication > Lazy Authentication Flow > should trigger OAuth independently for each provider when needed 0ms
   ✓ OAuthManager with OAuth Enablement and Lazy Authentication > Lazy Authentication Flow > should automatically refresh expiring tokens 0ms
   ✓ OAuthManager with OAuth Enablement and Lazy Authentication > Lazy Authentication Flow > should return null for OAuth disabled provider without triggering auth 0ms
   ✓ OAuthManager with OAuth Enablement and Lazy Authentication > Status Reporting with OAuth Enablement > should report OAuth enablement status for all providers 1ms
   ✓ OAuthManager with OAuth Enablement and Lazy Authentication > Status Reporting with OAuth Enablement > should include token expiry time in status 0ms
   ✓ OAuthManager with OAuth Enablement and Lazy Authentication > Status Reporting with OAuth Enablement > should report mixed OAuth enablement and authentication states accurately 2ms
   ✓ OAuthManager with OAuth Enablement and Lazy Authentication > Error Handling > should throw error for unknown provider OAuth toggle 1ms
   ✓ OAuthManager with OAuth Enablement and Lazy Authentication > Error Handling > should return null for unknown provider token request 0ms
   ✓ OAuthManager with OAuth Enablement and Lazy Authentication > Error Handling > should handle lazy authentication failures gracefully 13ms
   ✓ OAuthManager with OAuth Enablement and Lazy Authentication > Provider Discovery > should return empty list when no providers registered 0ms
   ✓ OAuthManager with OAuth Enablement and Lazy Authentication > Provider Discovery > should filter and return only OAuth-capable providers 0ms
   ✓ OAuthManager with OAuth Enablement and Lazy Authentication > Provider Discovery > should return providers in consistent sorted order regardless of registration order 0ms
   ✓ OAuthManager with OAuth Enablement and Lazy Authentication > Integration Scenarios > should support complete OAuth enablement and lazy auth lifecycle 0ms
   ✓ OAuthManager with OAuth Enablement and Lazy Authentication > Integration Scenarios > should persist OAuth enablement and tokens across manager instances 0ms
   × Higher priority auth detection > reports environment variable precedence when authOnly is disabled 1ms
     → [settings] No SettingsService registered in the active provider runtime context. Call activateIsolatedRuntimeContext() and registerSettingsService() before accessing settings (@plan:PLAN-20251023-STATELESS-HARDENING.P08, @requirement:REQ-SP4-004).
   × Higher priority auth detection > ignores environment variables when authOnly is enabled 0ms
     → [settings] No SettingsService registered in the active provider runtime context. Call activateIsolatedRuntimeContext() and registerSettingsService() before accessing settings (@plan:PLAN-20251023-STATELESS-HARDENING.P08, @requirement:REQ-SP4-004).
 ✓ src/config/settings.test.ts (57 tests | 1 skipped) 27ms
 ✓ src/services/FileCommandLoader.test.ts (35 tests) 180ms
 ✓ src/config/extension.test.ts (34 tests) 185ms
 ✓ test/auth/authRuntimeScope.test.ts (3 tests) 7ms
 ❯ src/ui/commands/providerCommand.test.ts (1 test | 1 failed) 12ms
   × providerCommand /provider save > saves provider alias configuration and refreshes aliases 10ms
     → expected { type: 'message', …(2) } to deeply equal { type: 'message', …(2) }
 ❯ src/config/config.test.ts (5 tests | 5 failed) 17ms
   × loadCliConfig - Invalid Profile/Provider Handling > Invalid profile handling > should throw error when loading non-existent profile 12ms
     → expected "spy" to be called with arguments: [ 'nonexistent' ][90m

Number of calls: [1m0[22m
[39m
   × loadCliConfig - Invalid Profile/Provider Handling > Invalid profile handling > should throw error when loading corrupted profile 1ms
     → expected "spy" to be called with arguments: [ 'corrupted' ][90m

Number of calls: [1m0[22m
[39m
   × loadCliConfig - Invalid Profile/Provider Handling > Invalid profile handling > should throw error when loading invalid profile with missing fields 0ms
     → expected "spy" to be called with arguments: [ 'invalid' ][90m

Number of calls: [1m0[22m
[39m
   × loadCliConfig - Invalid Profile/Provider Handling > Invalid profile handling > should throw error for unsupported profile version 0ms
     → expected "spy" to be called with arguments: [ 'old-version' ][90m

Number of calls: [1m0[22m
[39m
   × loadCliConfig - Invalid Profile/Provider Handling > Invalid provider handling > should throw error when explicitly setting invalid provider without profile 3ms
     → Storage.getGlobalLlxprtDir is not a function
 ✓ src/providers/providerManagerInstance.oauthRegistration.test.ts (2 tests) 1211ms
   ✓ Anthropic OAuth registration with environment key > registers Anthropic OAuth provider even when ANTHROPIC_API_KEY is set  726ms
   ✓ Anthropic OAuth registration with environment key > ignores API keys when authOnly is enabled  484ms
 ✓ src/utils/handleAutoUpdate.test.ts (10 tests) 11ms
 ✓ src/commands/mcp/remove.test.ts (2 tests) 14ms
 ✓ src/commands/extensions/uninstall.test.ts (1 test) 9ms
 ✓ src/commands/mcp/add.test.ts (5 tests) 79ms
 ✓ src/providers/logging/git-stats.test.ts (21 tests) 18ms
 ✓ src/services/prompt-processors/shellProcessor.test.ts (37 tests) 25ms
 ✓ src/runtime/__tests__/runtimeIsolation.test.ts (8 tests) 85ms
 ✓ src/ui/commands/authCommand.test.ts (22 tests) 10ms
 ❯ src/ui/commands/aboutCommand.test.ts (5 tests | 2 failed) 99ms
   ✓ aboutCommand > should have the correct name and description 2ms
   × aboutCommand > should call addItem with all version info 7ms
     → expected "spy" to be called with arguments: [ { type: 'about', …(11) }, …(1) ][90m

Received: 

[1m  1st spy call:

[22m[33m@@ -6,12 +6,12 @@[90m
[2m      "ideClient": "test-ide",[22m
[2m      "key": "",[22m
[2m      "keyfile": "",[22m
[2m      "modelVersion": "test-provider:test-model",[22m
[2m      "osVersion": "test-os",[22m
[32m-     "provider": "Unknown",[90m
[31m+     "provider": "test-provider",[90m
[2m      "sandboxEnv": "no sandbox",[22m
[2m      "selectedAuthType": "test-auth",[22m
[2m      "type": "about",[22m
[2m    },[22m
[32m-   Any<Number>,[90m
[31m+   1762019319404,[90m
[2m  ][22m
[39m[90m

Number of calls: [1m1[22m
[39m
   ✓ aboutCommand > should show the correct sandbox environment variable 1ms
   ✓ aboutCommand > should show sandbox-exec profile when applicable 87ms
   × aboutCommand > should not show ide client when it is not detected 1ms
     → expected "spy" to be called with arguments: [ ObjectContaining{…}, Any<Number> ][90m

Received: 

[1m  1st spy call:

[22m[2m  [[22m
[32m-   ObjectContaining {[90m
[31m+   {[90m
[2m      "baseURL": "",[22m
[2m      "cliVersion": "test-version",[22m
[2m      "gcpProject": "test-gcp-project",[22m
[2m      "ideClient": "",[22m
[31m+     "key": "",[90m
[31m+     "keyfile": "",[90m
[2m      "modelVersion": "test-provider:test-model",[22m
[2m      "osVersion": "test-os",[22m
[32m-     "provider": "Unknown",[90m
[31m+     "provider": "test-provider",[90m
[2m      "sandboxEnv": "no sandbox",[22m
[2m      "selectedAuthType": "test-auth",[22m
[2m      "type": "about",[22m
[2m    },[22m
[32m-   Any<Number>,[90m
[31m+   1762019319498,[90m
[2m  ][22m
[39m[90m

Number of calls: [1m1[22m
[39m
 ✓ src/ui/commands/chatCommand.test.ts (17 tests) 15ms
 ✓ src/ui/commands/clearCommand.test.ts (2 tests) 30ms
 ✓ src/ui/commands/compressCommand.test.ts (5 tests) 8ms
 ✓ src/ui/commands/memoryCommand.test.ts (8 tests) 11ms
 ✓ src/ui/commands/mcpCommand.test.ts (35 tests) 30ms
 ✓ src/ui/commands/initCommand.test.ts (3 tests) 54ms
 ✓ src/integration-tests/test-utils.test.ts (14 tests) 812ms
   ✓ Test Utilities > waitForFile > should timeout if file is not created  507ms
 ✓ src/ui/commands/toolsCommand.test.ts (6 tests) 9ms
 ✓ src/ui/hooks/useGeminiStream.subagent.spec.tsx (1 test) 14ms
 ✓ src/ui/commands/test/subagentCommand.test.ts (23 tests) 291ms
 ✓ src/ui/utils/clipboardUtils.test.ts (6 tests) 169ms
 ✓ src/storage/ConversationStorage.test.ts (11 tests) 87ms
 ✓ src/ui/components/InputPrompt.paste.spec.tsx (5 tests) 409ms
 ✓ src/ui/commands/setupGithubCommand.test.ts (10 tests | 2 skipped) 67ms
 ✓ src/ui/utils/commandUtils.test.ts (26 tests) 99ms
 ✓ src/ui/commands/restoreCommand.test.ts (13 tests) 127ms
 ✓ src/ui/commands/schema/argumentResolver.test.ts (42 tests) 394ms
 ✓ src/ui/utils/updateCheck.test.ts (12 tests) 38ms
 ✓ src/utils/userStartupWarnings.test.ts (5 tests) 20ms
 ✓ src/ui/themes/theme-manager.test.ts (18 tests) 32ms
 ✓ src/ui/commands/test/setCommand.phase09.test.ts (13 tests) 74ms
 ✓ src/auth/local-oauth-callback.spec.ts (2 tests) 40ms
 ✓ src/config/settingsSchema.test.ts (14 tests) 66ms
 ✓ src/ui/themes/semantic-tokens.test.ts (13 tests) 27ms
 ✓ test/ui/commands/authCommand-logout.test.ts (21 tests) 2607ms
   ✓ AuthCommand - Logout Property-Based Tests > should parse commands correctly with random whitespace (with seed=969888599)  335ms
   ✓ AuthCommand - Logout Property-Based Tests > should handle concurrent logout commands safely (with seed=-28431073)  1684ms
 ✓ src/ui/commands/keyCommand.test.ts (4 tests) 6ms
 ✓ src/ui/commands/statsCommand.test.ts (3 tests) 7ms
 ✓ src/commands/extensions/new.test.ts (4 tests) 15ms
 ✓ src/config/auth.test.ts (8 tests) 132ms
 ✓ src/auth/oauth-manager-initialization.spec.ts (7 tests) 8ms
 ✓ src/config/config.loadMemory.test.ts (1 test) 35ms
 ✓ src/services/CommandService.test.ts (11 tests) 12ms
 ✓ src/ui/commands/docsCommand.test.ts (3 tests) 4ms
 ✓ src/commands/extensions/install.test.ts (3 tests) 63ms
 ✓ src/utils/gitUtils.test.ts (12 tests) 10ms
 ✓ src/utils/settingsUtils.test.ts (68 tests) 9ms
 ✓ src/ui/utils/secureInputHandler.test.ts (25 tests) 5ms
 ✓ src/services/todo-continuation/todoContinuationService.spec.ts (33 tests) 7ms
 ✓ src/runtime/runtimeSettings.test.ts (9 tests) 7ms
 ✓ src/ui/commands/ideCommand.test.ts (9 tests) 5020ms
   ✓ ideCommand > install subcommand > should install the extension  5014ms
 ✓ src/ui/keyMatchers.test.ts (33 tests) 18ms
 ✓ src/auth/anthropic-oauth-provider.local-flow.spec.ts (2 tests) 13ms
 ✓ src/ui/commands/copyCommand.test.ts (11 tests) 57ms
 ✓ test/providers/providerAliases.test.ts (2 tests) 11ms
 ✓ src/commands/mcp/list.test.ts (4 tests) 9ms
 ✓ src/validateNonInterActiveAuth.test.ts (9 tests) 16ms
 ✓ src/ui/commands/setCommand.test.ts (13 tests) 8ms
 ✓ src/ui/commands/test/setCommand.mutation.test.ts (12 tests) 11ms
 ✓ src/ui/commands/test/subagentCommand.schema.test.ts (6 tests) 8ms
 ✓ src/providers/logging/LoggingProviderWrapper.test.ts (7 tests) 84ms
 ✓ src/ui/commands/helpCommand.test.ts (2 tests) 4ms
 ✓ src/ui/reducers/appReducer.test.ts (36 tests) 9ms
 ✓ src/ui/utils/computeStats.test.ts (12 tests) 5ms
 ✓ src/utils/privacy/ConversationDataRedactor.test.ts (10 tests) 6ms
 ✓ src/ui/utils/highlight.test.ts (11 tests) 4ms
 ✓ src/ui/commands/bugCommand.test.ts (2 tests) 4ms
 ✓ src/utils/installationInfo.test.ts (16 tests) 8ms
 ✓ src/config/keyBindings.test.ts (3 tests) 6ms
 ✓ src/providers/provider-gemini-switching.test.ts (3 tests) 7ms
 ✓ src/ui/themes/theme.test.ts (11 tests) 6ms
 ✓ src/config/__tests__/profileBootstrap.test.ts (4 tests) 9ms
 ✓ src/commands/mcp.test.ts (3 tests) 5ms
 ✓ src/config/trustedFolders.test.ts (17 tests) 7ms
 ✓ src/utils/envVarResolver.test.ts (16 tests) 4ms
 ✓ src/ui/commands/toolformatCommand.test.ts (6 tests) 5ms
 ✓ src/ui/commands/extensionsCommand.test.ts (2 tests) 16ms
 ✓ src/ui/commands/profileCommand.test.ts (7 tests) 7ms
 ✓ src/ui/themes/color-utils.test.ts (16 tests) 8ms
 ✓ src/utils/readStdin.test.ts (4 tests) 6ms
 ✓ src/ui/utils/markdownUtilities.test.ts (7 tests) 2ms
 ✓ src/ui/commands/terminalSetupCommand.test.ts (5 tests) 4ms
 ✓ src/providers/providerManagerInstance.test.ts (5 tests) 5ms
 ✓ src/ui/utils/responsive.test.ts (21 tests) 4ms
 ✓ src/config/cliEphemeralSettings.test.ts (6 tests) 3ms
 ✓ src/runtime/__tests__/profileApplication.test.ts (4 tests) 6ms
 ✓ src/utils/ConversationContext.test.ts (6 tests) 6ms
 ✓ src/runtime/providerConfigUtils.test.ts (6 tests) 5ms
 ✓ src/services/McpPromptLoader.test.ts (10 tests) 7ms
 ✓ src/ui/utils/formatters.test.ts (14 tests) 2ms
 ✓ src/config/logging/loggingConfig.test.ts (14 tests) 4ms
 ✓ src/test-utils/mockCommandContext.test.ts (3 tests) 4ms
 ✓ src/ui/commands/settingsCommand.test.ts (2 tests) 4ms
 ✓ src/ui/commands/themeCommand.test.ts (2 tests) 3ms
 ✓ src/providers/credentialPrecedence.test.ts (4 tests) 2ms
 ✓ src/ui/App.quittingMessages.test.ts (1 test) 2ms
 ✓ test/openai.stateless.stub.test.ts (1 test) 7ms
 ✓ src/services/prompt-processors/argumentProcessor.test.ts (2 tests) 4ms
 ✓ src/ui/commands/editorCommand.test.ts (2 tests) 6ms
 ✓ src/ui/themes/semantic-resolver.test.ts (6 tests) 3ms
 ✓ src/services/BuiltinCommandLoader.test.ts (4 tests) 3ms
 ✓ src/ui/utils/displayUtils.test.ts (5 tests) 2ms
 ✓ test/baseProvider.stateless.stub.test.ts (1 test) 2ms
 ✓ src/ui/useTodoPausePreserver.test.ts (1 test) 2ms
 ✓ src/config/extensions/variables.test.ts (1 test) 2ms
 ✓ test/openaiResponses.stateless.stub.test.ts (1 test) 1ms
 ↓ src/providers/logging/performance.test.ts (8 tests | 8 skipped)
 ✓ src/utils/startupWarnings.test.ts (4 tests) 4ms
 ✓ src/utils/cleanup.test.ts (4 tests) 5ms
 ✓ src/config/settings.env.test.ts (2 tests) 2ms
 ✓ src/config/__tests__/nonInteractiveTools.test.ts (1 test) 2ms
 ✓ src/auth/__tests__/oauthManager.safety.test.ts (3 tests) 2ms

⎯⎯⎯⎯⎯⎯ Failed Tests 10 ⎯⎯⎯⎯⎯⎯⎯

 FAIL  src/config/config.test.ts > loadCliConfig - Invalid Profile/Provider Handling > Invalid profile handling > should throw error when loading non-existent profile
AssertionError: expected "spy" to be called with arguments: [ 'nonexistent' ][90m

Number of calls: [1m0[22m
[39m
 ❯ src/config/config.test.ts:255:40
    253|         loadCliConfig(settings, extensions, sessionId, cliArgs),
    254|       ).rejects.toThrow();
    255|       expect(mockInstance.loadProfile).toHaveBeenCalledWith('nonexiste…
       |                                        ^
    256| 
    257|       consoleSpy.mockRestore();

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[1/10]⎯

 FAIL  src/config/config.test.ts > loadCliConfig - Invalid Profile/Provider Handling > Invalid profile handling > should throw error when loading corrupted profile
AssertionError: expected "spy" to be called with arguments: [ 'corrupted' ][90m

Number of calls: [1m0[22m
[39m
 ❯ src/config/config.test.ts:313:40
    311|         loadCliConfig(settings, extensions, sessionId, cliArgs),
    312|       ).rejects.toThrow();
    313|       expect(mockInstance.loadProfile).toHaveBeenCalledWith('corrupted…
       |                                        ^
    314| 
    315|       consoleSpy.mockRestore();

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[2/10]⎯

 FAIL  src/config/config.test.ts > loadCliConfig - Invalid Profile/Provider Handling > Invalid profile handling > should throw error when loading invalid profile with missing fields
AssertionError: expected "spy" to be called with arguments: [ 'invalid' ][90m

Number of calls: [1m0[22m
[39m
 ❯ src/config/config.test.ts:373:40
    371|         loadCliConfig(settings, extensions, sessionId, cliArgs),
    372|       ).rejects.toThrow();
    373|       expect(mockInstance.loadProfile).toHaveBeenCalledWith('invalid');
       |                                        ^
    374| 
    375|       consoleSpy.mockRestore();

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[3/10]⎯

 FAIL  src/config/config.test.ts > loadCliConfig - Invalid Profile/Provider Handling > Invalid profile handling > should throw error for unsupported profile version
AssertionError: expected "spy" to be called with arguments: [ 'old-version' ][90m

Number of calls: [1m0[22m
[39m
 ❯ src/config/config.test.ts:431:40
    429|         loadCliConfig(settings, extensions, sessionId, cliArgs),
    430|       ).rejects.toThrow();
    431|       expect(mockInstance.loadProfile).toHaveBeenCalledWith('old-versi…
       |                                        ^
    432| 
    433|       consoleSpy.mockRestore();

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[4/10]⎯

 FAIL  src/config/config.test.ts > loadCliConfig - Invalid Profile/Provider Handling > Invalid provider handling > should throw error when explicitly setting invalid provider without profile
TypeError: Storage.getGlobalLlxprtDir is not a function
 ❯ getUserAliasDir src/providers/providerAliases.ts:39:28
     37| 
     38| export function getUserAliasDir(): string {
     39|   return path.join(Storage.getGlobalLlxprtDir(), 'providers');
       |                            ^
     40| }
     41| 
 ❯ getAliasDirectories src/providers/providerAliases.ts:48:28
 ❯ loadProviderAliasEntries src/providers/providerAliases.ts:107:27
 ❯ createProviderManager src/providers/providerManagerInstance.ts:296:24
 ❯ prepareRuntimeForProfile src/config/profileBootstrap.ts:170:54
 ❯ Module.loadCliConfig src/config/config.ts:627:30
 ❯ src/config/config.test.ts:477:28

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[5/10]⎯

 FAIL  src/auth/oauth-manager.spec.ts > Higher priority auth detection > reports environment variable precedence when authOnly is disabled
Error: [settings] No SettingsService registered in the active provider runtime context. Call activateIsolatedRuntimeContext() and registerSettingsService() before accessing settings (@plan:PLAN-20251023-STATELESS-HARDENING.P08, @requirement:REQ-SP4-004).
 ❯ getSettingsService ../core/src/settings/settingsServiceInstance.ts:32:9
 ❯ OAuthManager.getHigherPriorityAuth src/auth/oauth-manager.ts:580:29
    578| 
    579|     const merged = this.settings.merged;
    580|     const settingsService = getSettingsService();
       |                             ^
    581|     const authOnly = isAuthOnlyEnabled(settingsService.get('authOnly')…
    582| 
 ❯ src/auth/oauth-manager.spec.ts:718:34

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[6/10]⎯

 FAIL  src/auth/oauth-manager.spec.ts > Higher priority auth detection > ignores environment variables when authOnly is enabled
Error: [settings] No SettingsService registered in the active provider runtime context. Call activateIsolatedRuntimeContext() and registerSettingsService() before accessing settings (@plan:PLAN-20251023-STATELESS-HARDENING.P08, @requirement:REQ-SP4-004).
 ❯ getSettingsService ../core/src/settings/settingsServiceInstance.ts:32:9
 ❯ src/auth/oauth-manager.spec.ts:728:29
    726|     const manager = new OAuthManager(tokenStore, loadedSettings);
    727| 
    728|     const settingsService = getSettingsService();
       |                             ^
    729|     settingsService.set('authOnly', true);
    730| 

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[7/10]⎯

 FAIL  src/ui/commands/aboutCommand.test.ts > aboutCommand > should call addItem with all version info
AssertionError: expected "spy" to be called with arguments: [ { type: 'about', …(11) }, …(1) ][90m

Received: 

[1m  1st spy call:

[22m[33m@@ -6,12 +6,12 @@[90m
[2m      "ideClient": "test-ide",[22m
[2m      "key": "",[22m
[2m      "keyfile": "",[22m
[2m      "modelVersion": "test-provider:test-model",[22m
[2m      "osVersion": "test-os",[22m
[32m-     "provider": "Unknown",[90m
[31m+     "provider": "test-provider",[90m
[2m      "sandboxEnv": "no sandbox",[22m
[2m      "selectedAuthType": "test-auth",[22m
[2m      "type": "about",[22m
[2m    },[22m
[32m-   Any<Number>,[90m
[31m+   1762019319404,[90m
[2m  ][22m
[39m[90m

Number of calls: [1m1[22m
[39m
 ❯ src/ui/commands/aboutCommand.test.ts:112:36
    110|     await aboutCommand.action(mockContext, '');
    111| 
    112|     expect(mockContext.ui.addItem).toHaveBeenCalledWith(
       |                                    ^
    113|       {
    114|         type: MessageType.ABOUT,

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[8/10]⎯

 FAIL  src/ui/commands/aboutCommand.test.ts > aboutCommand > should not show ide client when it is not detected
AssertionError: expected "spy" to be called with arguments: [ ObjectContaining{…}, Any<Number> ][90m

Received: 

[1m  1st spy call:

[22m[2m  [[22m
[32m-   ObjectContaining {[90m
[31m+   {[90m
[2m      "baseURL": "",[22m
[2m      "cliVersion": "test-version",[22m
[2m      "gcpProject": "test-gcp-project",[22m
[2m      "ideClient": "",[22m
[31m+     "key": "",[90m
[31m+     "keyfile": "",[90m
[2m      "modelVersion": "test-provider:test-model",[22m
[2m      "osVersion": "test-os",[22m
[32m-     "provider": "Unknown",[90m
[31m+     "provider": "test-provider",[90m
[2m      "sandboxEnv": "no sandbox",[22m
[2m      "selectedAuthType": "test-auth",[22m
[2m      "type": "about",[22m
[2m    },[22m
[32m-   Any<Number>,[90m
[31m+   1762019319498,[90m
[2m  ][22m
[39m[90m

Number of calls: [1m1[22m
[39m
 ❯ src/ui/commands/aboutCommand.test.ts:176:36
    174|     await aboutCommand.action(mockContext, '');
    175| 
    176|     expect(mockContext.ui.addItem).toHaveBeenCalledWith(
       |                                    ^
    177|       expect.objectContaining({
    178|         type: MessageType.ABOUT,

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[9/10]⎯

 FAIL  src/ui/commands/providerCommand.test.ts > providerCommand /provider save > saves provider alias configuration and refreshes aliases
AssertionError: expected { type: 'message', …(2) } to deeply equal { type: 'message', …(2) }

[32m- Expected[39m
[31m+ Received[39m

[2m  {[22m
[32m-   "content": StringContaining "myalias",[39m
[32m-   "messageType": "info",[39m
[31m+   "content": "Failed to switch provider: MissingProviderRuntimeError(provider-runtime): runtime registration missing. Run activateIsolatedRuntimeContext() before invoking providers (REQ-SP4-004).",[39m
[31m+   "messageType": "error",[39m
[2m    "type": "message",[22m
[2m  }[22m

 ❯ src/ui/commands/providerCommand.test.ts:108:20
    106|     const result = await providerCommand.action(context, 'save myalias…
    107| 
    108|     expect(result).toEqual({
       |                    ^
    109|       type: 'message',
    110|       messageType: 'info',

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[10/10]⎯


 Test Files  4 failed | 116 passed | 1 skipped (121)
      Tests  10 failed | 1285 passed | 11 skipped (1306)
   Start at  14:48:31
   Duration  24.27s (transform 4.62s, setup 5.72s, collect 112.35s, tests 13.42s, environment 84.55s, prepare 15.03s)

JUNIT report written to /Users/acoliver/projects/llxprt-code/packages/cli/junit.fast.xml
npm error Lifecycle script `test:ci:fast` failed with error:
npm error code 1
npm error path /Users/acoliver/projects/llxprt-code/packages/cli
npm error workspace @vybestack/llxprt-code@0.5.0
npm error location /Users/acoliver/projects/llxprt-code/packages/cli
npm error command failed
npm error command sh -c vitest run -c vitest.ci.fast.config.ts
npm error Lifecycle script `test:ci` failed with error:
npm error code 1
npm error path /Users/acoliver/projects/llxprt-code/packages/cli
npm error workspace @vybestack/llxprt-code@0.5.0
npm error location /Users/acoliver/projects/llxprt-code/packages/cli
npm error command failed
npm error command sh -c npm run test:ci:covered && npm run test:ci:fast


> @vybestack/llxprt-code-core@0.5.0 test:ci
> vitest run --coverage


 RUN  v3.2.4 /Users/acoliver/projects/llxprt-code/packages/core
      Coverage enabled with v8

 ❯ src/providers/ProviderManager.test.ts (3 tests | 1 failed) 56ms
   × ProviderManager provider ordering > prioritizes core providers and sorts remaining alphabetically 8ms
     → MissingProviderRuntimeError(provider-runtime): runtime registration missing. Run activateIsolatedRuntimeContext() before invoking providers (REQ-SP4-004).
   ✓ ProviderPerformanceTracker > should accumulate session tokens correctly 46ms
   ✓ ProviderPerformanceTracker > should reset session token usage 0ms
 ✓ src/integration/compression-duplicate-ids.test.ts (2 tests) 1161ms
   ✓ Compression and duplicate tool call IDs > should not create duplicate tool IDs when rebuilding history after compression  731ms
 ✓ src/mcp/token-storage/file-token-storage.test.ts (16 tests) 1615ms
 ❯ src/providers/openai/OpenAIProvider.toolFormatDetection.test.ts (2 tests | 1 failed) 10ms
   × OpenAIProvider tool format detection > detects qwen format for GLM models 9ms
     → expected 'openai' to be 'qwen' // Object.is equality
   ✓ OpenAIProvider tool format detection > keeps openai format for non-GLM models 0ms
 ❯ src/core/geminiChat.contextlimit.test.ts (3 tests | 3 failed) 17ms
   × GeminiChat Context Limit Enforcement > should enforce context window using user-configured context-limit 15ms
     → Cannot read properties of undefined (reading 'model')
   × GeminiChat Context Limit Enforcement > should not trigger compression when within context-limit 0ms
     → Cannot read properties of undefined (reading 'model')
   × GeminiChat Context Limit Enforcement > should use context-limit when available, falling back to default when not set 0ms
     → Cannot read properties of undefined (reading 'model')
 ✓ src/prompt-config/prompt-service.test.ts (45 tests) 2382ms
 ❯ src/core/geminiChat.runtime.test.ts (1 test | 1 failed) 341ms
   × GeminiChat runtime context > passes runtime context and tools to provider generateChatCompletion 340ms
     → Request would exceed the 60000 token context window even after compression (projected 65539 tokens including system prompt and a 65536 token completion budget). Reduce earlier history or lower maxOutputTokens.
 ✓ src/utils/toolOutputLimiter.test.ts (14 tests) 1108ms
   ✓ toolOutputLimiter > limitOutputTokens > should truncate content in truncate mode  438ms
 ✓ src/tools/glob.test.ts (34 tests) 1851ms
 ✓ src/tools/grep.test.ts (24 tests) 958ms
   ✓ GrepTool > execute > should find matches for a simple pattern in all files  526ms
 ✓ src/services/history/compression-locking.test.ts (4 tests) 1280ms
   ✓ Compression locking > should queue adds during compression  449ms
   ✓ Compression locking > should serialize multiple compressions  323ms
 ✓ src/services/history/circular-reference.test.ts (4 tests) 1207ms
   ✓ Circular Reference Bug > should not create circular references when getCurated is called during tool execution  400ms
   ✓ Circular Reference Bug > should not create synthetic responses when tool responses exist in full history  322ms
 ✓ src/integration-tests/geminiChat-isolation.integration.test.ts (11 tests) 1049ms
   ✓ GeminiChat Isolation Integration Tests > History Isolation > should maintain independent history services between foreground and subagent  568ms
   ✓ GeminiChat Isolation Integration Tests > History Isolation > should not share history between multiple subagents  429ms
 ✓ src/services/history/orphaned-tools-comprehensive.test.ts (9 tests | 4 skipped) 1106ms
   ✓ Orphaned Tool Calls - Comprehensive Tests > getCurated WITHOUT orphans > should NOT add synthetic responses when tool responses exist  352ms
   ✓ Orphaned Tool Calls - Comprehensive Tests > getCuratedForProvider should not create circular references > should not modify original history when patching  316ms
 ✓ src/core/subagent.test.ts (27 tests) 2224ms
 ✓ src/services/history/HistoryService.test.ts (23 tests) 4301ms
   ✓ HistoryService - Behavioral Tests > Import/Export > should export and import history via JSON  790ms
   ✓ HistoryService - Behavioral Tests > Edge Cases > should handle thinking blocks appropriately  313ms
   ✓ HistoryService - Behavioral Tests > ID Normalization Architecture - NEW FAILING TESTS > Base token offset > retains base offset after clearing history  307ms
   ✓ HistoryService - Behavioral Tests > ID Normalization Architecture - NEW FAILING TESTS > Base token offset > estimates tokens for raw text input  335ms
 ✓ src/services/shellExecutionService.env.test.ts (3 tests) 75ms
 ✓ src/prompt-config/prompt-loader.test.ts (44 tests) 872ms
   ✓ PromptLoader > watchFiles > should notify on file changes  311ms
 ✓ src/services/history/findfiles-circular.test.ts (2 tests) 521ms
   ✓ FindFiles Circular Reference Bug > getCuratedForProvider should handle FindFiles tool call with complex parameters  302ms
 ✓ src/services/loopDetectionService.test.ts (34 tests) 442ms
 ✓ src/debug/DebugLogger.test.ts (36 tests | 1 skipped) 451ms
 ✓ src/prompt-config/prompt-installer.test.ts (49 tests) 319ms
 ✓ src/tools/ripGrep.test.ts (36 tests) 459ms
 ✓ src/tools/read-many-files.test.ts (32 tests) 819ms
 ✓ src/prompt-config/prompt-resolver.test.ts (56 tests) 323ms
 ✓ src/providers/openai/OpenAIProvider.stateful.integration.test.ts (2 tests | 1 skipped) 1199ms
   ✓ OpenAIProvider Stateful Integration > should not break stateless models by correctly passing full message history  1196ms
 ✓ src/tools/read-file.test.ts (34 tests) 494ms
 ✓ src/utils/filesearch/fileSearch.test.ts (27 tests) 275ms
 ✓ src/filters/EmojiFilter.property.test.ts (30 tests) 354ms
 ✓ src/tools/shell.test.ts (35 tests) 759ms
   ✓ ShellTool > execute > should wrap command on linux and parse pgrep output  400ms
 ✓ src/core/logger.test.ts (38 tests) 351ms
 ✓ src/utils/bfsFileSearch.test.ts (11 tests) 256ms
 ✓ src/tools/shell.multibyte.test.ts (1 test) 397ms
   ✓ ShellTool multibyte handling > preserves full multibyte output in returnDisplay  396ms
 ✓ src/core/client.test.ts (66 tests | 6 skipped) 483ms
 ✓ src/config/test/subagentManager.test.ts (23 tests) 183ms
 ✓ src/tools/mcp-tool.test.ts (42 tests) 196ms
 ✓ src/utils/memoryDiscovery.test.ts (16 tests) 382ms
 ✓ src/utils/fileUtils.test.ts (62 tests) 320ms
 ✓ src/tools/edit.test.ts (42 tests) 256ms
 ✓ src/providers/integration/multi-provider.integration.test.ts (12 tests | 1 skipped) 573ms
   ✓ Multi-Provider Integration Tests > Error Handling > should handle missing API key  570ms
 ✓ src/auth/token-store.spec.ts (20 tests) 202ms
 ✓ src/tools/write-file.test.ts (25 tests) 166ms
 ✓ src/core/coreToolScheduler.test.ts (28 tests | 6 skipped) 224ms
 ✓ src/tools/modifiable-tool.test.ts (11 tests) 80ms
 ✓ src/utils/filesearch/crawler.test.ts (18 tests) 161ms
 ✓ src/utils/getFolderStructure.test.ts (15 tests) 182ms
 ✓ src/services/gitService.test.ts (14 tests) 247ms
 ✓ src/core/prompts.test.ts (6 tests) 203ms
 ✓ src/utils/gitIgnoreParser.test.ts (23 tests) 278ms
 ✓ src/tools/ls.test.ts (22 tests) 242ms
 ✓ src/mcp/oauth-provider.test.ts (19 tests) 235ms
 ✓ src/providers/openai/__tests__/openai.stateless.test.ts (4 tests) 347ms
   ✓ OpenAI provider stateless contract tests > creates client per runtime @plan:PLAN-20251018-STATELESSPROVIDER2.P08 @requirement:REQ-SP2-001 @pseudocode openai-responses-stateless.md lines 1-4  337ms
 ✓ src/providers/openai/OpenAIProvider.modelParamsAndHeaders.test.ts (3 tests) 10ms
 ✓ src/tools/smart-edit.test.ts (18 tests) 181ms
 ✓ src/tools/web-fetch.integration.test.ts (22 tests) 242ms
 ✓ src/utils/errorReporting.test.ts (6 tests) 62ms
 ✓ src/runtime/AgentRuntimeState.spec.ts (48 tests) 122ms
 ✓ src/services/ClipboardService.test.ts (7 tests) 22ms
 ✓ src/utils/paths.test.ts (55 tests) 8ms
 ✓ src/services/fileDiscoveryService.test.ts (15 tests) 200ms
 ✓ src/mcp/token-storage/keychain-token-storage.test.ts (24 tests) 173ms
 ✓ src/core/prompts-async.test.ts (9 tests | 1 skipped) 225ms
 ✓ src/tools/list-subagents.test.ts (4 tests) 48ms
 ✓ src/prompt-config/prompt-cache.test.ts (42 tests) 21ms
 ✓ src/utils/schemaValidator.test.ts (7 tests) 58ms
 ✓ src/providers/anthropic/AnthropicProvider.oauth.test.ts (9 tests) 84ms
 ✓ src/providers/gemini/__tests__/gemini.stateless.test.ts (5 tests) 162ms
 ✓ src/services/shellExecutionService.test.ts (30 tests) 65ms
 ✓ src/telemetry/uiTelemetry.test.ts (19 tests) 80ms
 ✓ src/utils/editor.test.ts (108 tests) 53ms
 ✓ src/runtime/providerRuntimeContext.test.ts (3 tests) 8ms
 ✓ src/utils/secure-browser-launcher.test.ts (14 tests) 10ms
 ✓ src/code_assist/oauth2.test.ts (11 tests) 81ms
 ✓ src/core/atomic-compression.test.ts (2 tests) 125ms
 ✓ src/utils/memoryImportProcessor.issue391.test.ts (5 tests) 106ms
 ✓ src/utils/userAccountManager.test.ts (23 tests) 139ms
 ❯ src/core/geminiChat.test.ts (34 tests | 15 failed) 10573ms
   × GeminiChat > sendMessage > should call generateContent with the correct parameters 220ms
     → Request would exceed the 60000 token context window even after compression (projected 65537 tokens including system prompt and a 65536 token completion budget). Reduce earlier history or lower maxOutputTokens.
   × GeminiChat > sendMessage > should trigger compression when pending tokens exceed threshold 1ms
     → Request would exceed the 60000 token context window even after compression (projected 130536 tokens including system prompt and a 65536 token completion budget). Reduce earlier history or lower maxOutputTokens.
   × GeminiChat > sendMessage > should not trigger compression when pending tokens stay under threshold 1ms
     → Request would exceed the 60000 token context window even after compression (projected 67036 tokens including system prompt and a 65536 token completion budget). Reduce earlier history or lower maxOutputTokens.
   × GeminiChat > sendMessageStream > should call generateContentStream with the correct parameters 297ms
     → Request would exceed the 60000 token context window even after compression (projected 65537 tokens including system prompt and a 65536 token completion budget). Reduce earlier history or lower maxOutputTokens.
   ✓ GeminiChat > recordHistory > should add user input and a single model output to history 266ms
   ✓ GeminiChat > recordHistory > should consolidate adjacent model outputs 241ms
   ✓ GeminiChat > recordHistory > should handle a mix of user and model roles in outputContents (though unusual)  319ms
   ✓ GeminiChat > recordHistory > should consolidate multiple adjacent model outputs correctly  313ms
   ✓ GeminiChat > recordHistory > should not consolidate if roles are different between model outputs  356ms
   ✓ GeminiChat > recordHistory > should merge with last history entry if it is also a model output  535ms
   ✓ GeminiChat > recordHistory > should correctly merge consolidated new output with existing model history 274ms
   ✓ GeminiChat > recordHistory > should handle empty modelOutput array 297ms
   ✓ GeminiChat > recordHistory > should handle aggregating modelOutput 282ms
   ✓ GeminiChat > recordHistory > should handle modelOutput with parts being undefined or empty (if they pass initial every check)  301ms
   ✓ GeminiChat > recordHistory > should correctly handle automaticFunctionCallingHistory 243ms
   ✓ GeminiChat > recordHistory > should add userInput if AFC history is present but empty 219ms
   ✓ GeminiChat > recordHistory > should skip "thought" content from modelOutput  369ms
   ✓ GeminiChat > recordHistory > should skip "thought" content even if it is the only content  341ms
   ✓ GeminiChat > recordHistory > should correctly consolidate text parts when a thought part is in between  321ms
   ✓ GeminiChat > recordHistory > should handle multiple thought parts correctly  343ms
   ✓ GeminiChat > recordHistory > should handle thought part at the end of outputContents 295ms
   ✓ GeminiChat > addHistory > should add a new content item to the history 243ms
   ✓ GeminiChat > addHistory > should add multiple items correctly  304ms
   × GeminiChat > sendMessageStream with retries > should yield a RETRY event when an invalid stream is encountered 337ms
     → Request would exceed the 60000 token context window even after compression (projected 65537 tokens including system prompt and a 65536 token completion budget). Reduce earlier history or lower maxOutputTokens.
   × GeminiChat > sendMessageStream with retries > should retry on invalid content and succeed on the second attempt 361ms
     → Request would exceed the 60000 token context window even after compression (projected 65537 tokens including system prompt and a 65536 token completion budget). Reduce earlier history or lower maxOutputTokens.
   × GeminiChat > sendMessageStream with retries > should fail after all retries on persistent invalid content 374ms
     → expected error to be instance of EmptyStreamError
   × GeminiChat > should correctly retry and append to an existing history mid-conversation 282ms
     → Request would exceed the 60000 token context window even after compression (projected 65542 tokens including system prompt and a 65536 token completion budget). Reduce earlier history or lower maxOutputTokens.
   × GeminiChat > concurrency control > should queue a subsequent sendMessage call until the first one completes 275ms
     → expected "spy" to be called 1 times, but got 0 times
   × GeminiChat > should retry if the model returns a completely empty stream (no chunks) 451ms
     → Request would exceed the 60000 token context window even after compression (projected 65539 tokens including system prompt and a 65536 token completion budget). Reduce earlier history or lower maxOutputTokens.
   × GeminiChat > should queue a subsequent sendMessageStream call until the first stream is fully consumed 464ms
     → Request would exceed the 60000 token context window even after compression (projected 65537 tokens including system prompt and a 65536 token completion budget). Reduce earlier history or lower maxOutputTokens.
   × GeminiChat > should retry when all content is invalid and succeed on the second attempt 429ms
     → Request would exceed the 60000 token context window even after compression (projected 65537 tokens including system prompt and a 65536 token completion budget). Reduce earlier history or lower maxOutputTokens.
   × GeminiChat > normalizeToolInteractionInput > should handle flattened tool call/response arrays from UI 451ms
     → Request would exceed the 60000 token context window even after compression (projected 65582 tokens including system prompt and a 65536 token completion budget). Reduce earlier history or lower maxOutputTokens.
   × GeminiChat > normalizeToolInteractionInput > should handle single paired tool call/response (2 elements) 367ms
     → Request would exceed the 60000 token context window even after compression (projected 65557 tokens including system prompt and a 65536 token completion budget). Reduce earlier history or lower maxOutputTokens.
   × GeminiChat > stateless runtime context compliance > should not rely on global provider runtime context 403ms
     → promise rejected "Error: Request would exceed the 60000 tok…" instead of resolving
 ✓ src/tools/memoryTool.test.ts (19 tests) 69ms
 ✓ src/utils/systemEncoding.test.ts (38 tests) 13ms
 ✓ src/tools/task.test.ts (7 tests) 159ms
 ✓ src/utils/workspaceContext.test.ts (34 tests) 46ms
 ✓ src/tools/web-search.test.ts (9 tests) 120ms
 ✓ src/utils/environmentContext.test.ts (8 tests) 79ms
 ✓ src/utils/memoryImportProcessor.test.ts (23 tests) 40ms
 ✓ src/auth/oauth-errors.spec.ts (38 tests | 2 skipped) 99ms
 ✓ src/parsers/TextToolCallParser.test.ts (15 tests) 44ms
 ✓ src/auth/precedence.test.ts (23 tests) 9ms
 ✓ src/auth/auth-integration.spec.ts (11 tests) 12ms
 ✓ src/providers/anthropic/AnthropicProvider.test.ts (13 tests) 57ms
 ✓ src/telemetry/metrics.test.ts (11 tests) 70ms
 ✓ src/ide/ideContext.test.ts (16 tests) 7ms
 ✓ src/tools/todo-store.test.ts (13 tests) 58ms
 ✓ src/core/turn.test.ts (14 tests) 11ms
 ✓ src/tools/todo-write.test.ts (21 tests) 16ms
 ✓ src/providers/anthropic/__tests__/anthropic.stateless.test.ts (4 tests) 166ms
 ✓ src/utils/filesearch/ignore.test.ts (12 tests) 19ms
 ✓ src/prompt-config/TemplateEngine.test.ts (31 tests) 22ms
 ✓ src/config/config.test.ts (46 tests) 36ms
 ✓ src/utils/retry.test.ts (14 tests) 106ms
 ✓ src/tools/todo-schemas.test.ts (26 tests) 8ms
 ✓ src/mcp/token-storage/base-token-storage.test.ts (12 tests) 4ms
 ✓ src/utils/filesearch/crawlCache.test.ts (9 tests) 12ms
 ✓ src/code_assist/server.test.ts (7 tests) 16ms
 ✓ src/providers/BaseProvider.test.ts (21 tests) 14ms
 ✓ src/ide/ide-client.test.ts (4 tests) 9ms
 ✓ src/providers/openai-responses/__tests__/openaiResponses.stateless.test.ts (4 tests) 10ms
 ✓ src/runtime/__tests__/regression-guards.test.ts (13 tests) 10ms
 ✓ src/filters/EmojiFilter.consistency.test.ts (58 tests) 17ms
 ✓ src/core/nonInteractiveToolExecutor.test.ts (8 tests) 98ms
 ✓ src/tools/web-fetch.test.ts (7 tests) 73ms
 ✓ src/providers/openai/parseResponsesStream.responsesToolCalls.test.ts (7 tests) 44ms
 ✓ src/debug/FileOutput.test.ts (15 tests) 21ms
 ✓ src/ide/process-utils.test.ts (7 tests) 8ms
 ✓ src/providers/openai/buildResponsesRequest.test.ts (22 tests) 11ms
 ✓ src/utils/summarizer.test.ts (8 tests) 17ms
 ✓ src/debug/ConfigurationManager.test.ts (25 tests) 12ms
 ✓ src/tools/tool-registry.test.ts (17 tests) 54ms
 ✓ src/tools/mcp-client.test.ts (42 tests) 18ms
 ✓ src/mcp/file-token-store.test.ts (27 tests) 18ms
 ✓ src/runtime/AgentRuntimeContext.stateless.test.ts (2 tests) 6ms
 ✓ src/core/__tests__/subagent.stateless.test.ts (13 tests) 12ms
 ✓ src/filters/EmojiFilter.test.ts (68 tests) 28ms
 ✓ src/config/profileManager.test.ts (17 tests) 11ms
 ✓ src/utils/shell-utils.test.ts (49 tests) 8ms
 ✓ src/providers/openai/openai-oauth.spec.ts (25 tests) 13ms
 ✓ src/services/shellExecutionService.windows.multibyte.test.ts (5 tests | 1 skipped) 32ms
 ✓ src/ide/ide-installer.test.ts (10 tests) 8ms
 ✓ src/mcp/google-auth-provider.test.ts (4 tests) 12ms
 ✓ src/services/history/ContentConverters.test.ts (30 tests) 10ms
 ✓ src/mcp/token-storage/hybrid-token-storage.test.ts (11 tests) 8ms
 ✓ src/providers/ProviderManager.gemini-switch.test.ts (3 tests) 6ms
 ✓ src/core/contentGenerator.test.ts (7 tests) 9ms
 ✓ src/mcp/oauth-token-storage.test.ts (20 tests) 19ms
 ✓ src/services/shellExecutionService.multibyte.test.ts (2 tests) 5ms
 ✓ src/integration-tests/todo-system.test.ts (2 tests) 4ms
 ✓ src/telemetry/loggers.test.ts (12 tests) 10ms
 ✓ src/code_assist/converter.test.ts (21 tests) 5ms
 ✓ src/config/flashFallback.test.ts (6 tests) 15ms
 ✓ src/tools/todo-read.test.ts (13 tests) 18ms
 ✓ src/core/__tests__/geminiClient.runtimeState.test.ts (13 tests) 8ms
 ✓ src/services/complexity-analyzer.test.ts (6 tests) 6ms
 ✓ src/telemetry/telemetry.test.ts (2 tests) 19ms
 ✓ src/tools/ToolFormatter.toResponsesTool.test.ts (6 tests) 4ms
 ✓ src/providers/openai-responses/OpenAIResponsesProvider.headers.test.ts (1 test) 6ms
 ✓ src/integration-tests/settings-remediation.test.ts (13 tests) 14ms
 ✓ src/parsers/TextToolCallParser.multibyte.test.ts (1 test) 5ms
 ✓ test/settings/SettingsService.spec.ts (31 tests) 7ms
 ✓ src/utils/installationManager.test.ts (4 tests) 5ms
 ✓ src/core/__tests__/geminiChat.runtimeState.test.ts (12 tests) 9ms
 ✓ src/utils/ignorePatterns.test.ts (28 tests) 9ms
 ✓ src/mcp/oauth-utils.test.ts (21 tests) 7ms
 ✓ src/providers/logging/ProviderPerformanceTracker.test.ts (8 tests) 8ms
 ✓ src/providers/__tests__/ProviderManager.guard.test.ts (8 tests) 9ms
 ✓ src/tools/todo-pause.spec.ts (21 tests) 5ms
 ✓ src/utils/errorParsing.test.ts (23 tests) 10ms
 ✓ src/core/__tests__/config-regression-guard.test.ts (6 tests) 5ms
 ✓ src/tools/tools.test.ts (11 tests) 7ms
 ✓ src/providers/__tests__/baseProvider.stateless.test.ts (3 tests) 10ms
 ✓ src/runtime/AgentRuntimeLoader.test.ts (4 tests) 9ms
 ✓ src/code_assist/setup.test.ts (7 tests) 9ms
 ✓ src/auth/__tests__/authRuntimeScope.test.ts (3 tests) 6ms
 ✓ src/mcp/token-store.test.ts (23 tests) 5ms
 ✓ src/config/endpoints.test.ts (26 tests) 22ms
 ✓ src/utils/shell-utils.shellReplacement.test.ts (14 tests) 8ms
 ✓ src/runtime/__tests__/AgentRuntimeState.stub.test.ts (13 tests | 10 skipped) 4ms
 ✓ src/core/subagentOrchestrator.test.ts (7 tests) 14ms
 ✓ src/providers/gemini/GeminiProvider.test.ts (8 tests) 9ms
 ✓ src/tools/ToolFormatter.test.ts (10 tests) 25ms
 ✓ src/utils/generateContentResponseUtilities.test.ts (36 tests) 9ms
 ✓ src/tools/diffOptions.test.ts (9 tests) 4ms
 ✓ src/integration-tests/profile-integration.test.ts (4 tests) 8ms
 ✓ src/providers/openai/estimateRemoteTokens.test.ts (10 tests) 3ms
 ✓ src/utils/unicodeUtils.test.ts (15 tests) 5ms
 ✓ src/providers/providerInterface.compat.test.ts (2 tests) 5ms
 ✓ src/integration-tests/provider-settings-integration.spec.ts (4 tests) 6ms
 ✓ src/providers/__tests__/BaseProvider.guard.test.ts (2 tests) 7ms
 ✓ src/providers/openai/getOpenAIProviderInfo.context.test.ts (3 tests) 21ms
 ✓ src/services/fileSystemService.test.ts (3 tests) 4ms
 ✓ src/config/config.alwaysAllow.test.ts (9 tests) 7ms
 ✓ src/providers/openai/OpenAIProvider.setModel.test.ts (3 tests) 5ms
 ✓ src/providers/openai/buildResponsesRequest.stripToolCalls.test.ts (3 tests) 5ms
 ✓ src/providers/gemini/GeminiProvider.e2e.test.ts (3 tests) 2ms
 ✓ src/test-utils/__tests__/providerCallOptions.test.ts (2 tests) 4ms
 ✓ src/core/googleGenAIWrapper.test.ts (3 tests) 6ms
 ✓ src/config/storage.test.ts (16 tests) 7ms
 ✓ src/providers/openai/openaiRequestParams.test.ts (2 tests) 6ms
 ✓ src/ide/detect-ide.test.ts (22 tests) 4ms
 ✓ src/utils/partUtils.test.ts (23 tests) 5ms
 ✓ src/providers/__tests__/LoggingProviderWrapper.stateless.test.ts (4 tests) 5ms
 ✓ src/utils/sanitization.test.ts (14 tests) 4ms
 ✓ src/utils/filesearch/result-cache.test.ts (3 tests) 3ms
 ✓ test/settings/model-diagnostics.test.ts (5 tests) 6ms
 ✓ src/services/tool-call-tracker-service.test.ts (6 tests) 5ms
 ✓ src/prompt-config/defaults/manifest-loader.test.ts (2 tests) 4ms
 ✓ src/providers/openai/buildResponsesRequest.undefined.test.ts (3 tests) 4ms
 ✓ src/utils/safeJsonStringify.test.ts (8 tests) 9ms
 ✓ src/providers/openai/ConversationCache.accumTokens.test.ts (9 tests) 3ms
 ✓ src/runtime/RuntimeInvocationContext.failfast.test.ts (2 tests) 4ms
 ✓ src/core/tokenLimits.test.ts (15 tests) 3ms
 ✓ src/providers/openai/__tests__/formatArrayResponse.test.ts (13 tests) 7ms
 ✓ src/providers/providerManager.context.test.ts (2 tests) 4ms
 ✓ src/config/config.ephemeral.test.ts (10 tests) 6ms
 ✓ src/providers/openai/parseResponsesStream.test.ts (11 tests | 5 skipped) 2ms
 ✓ src/providers/anthropic/AnthropicProvider.toolFormatDetection.test.ts (2 tests) 2ms
 ✓ src/auth/precedence.adapter.test.ts (1 test) 3ms
 ✓ src/code_assist/oauth2.e2e.test.ts (1 test) 3ms
 ✓ src/hooks/tool-render-suppression-hook.test.ts (2 tests) 3ms
 ✓ src/index.test.ts (1 test) 2ms
 ↓ src/services/shellExecutionService.windows.test.ts (3 tests | 3 skipped)
 ↓ src/providers/__tests__/BaseProvider.guard.stub.test.ts (1 test | 1 skipped)
 ✓ src/utils/tool-utils.test.ts (7 tests) 2ms
 ↓ src/services/history/orphaned-tools.test.ts (6 tests | 6 skipped)
 ✓ src/tools/mcp-client-manager.test.ts (2 tests) 4ms
 ✓ src/core/__tests__/compression-logic.test.ts (1 test) 2ms
 ✓ src/core/__tests__/compression.test.ts (1 test) 2ms
 ↓ src/providers/openai/OpenAIProvider.callResponses.stateless.test.ts (5 tests | 5 skipped)
 ↓ src/providers/openai/OpenAIProvider.integration.test.ts (3 tests | 3 skipped)
 ↓ src/providers/openai/OpenAIProvider.responsesIntegration.test.ts (6 tests | 6 skipped)
 ↓ src/providers/openai/ResponsesContextTrim.integration.test.ts (4 tests | 4 skipped)
 ✓ src/providers/anthropic/AnthropicProvider.modelParams.test.ts (1 test) 2ms
 ✓ src/auth/qwen-device-flow.spec.ts (24 tests) 40330ms
   ✓ QwenDeviceFlow - Behavioral Tests > Token Polling > should poll for token until authorization completes  10016ms
   ✓ QwenDeviceFlow - Behavioral Tests > Token Polling > should use correct Qwen token endpoint  1451ms
   ✓ QwenDeviceFlow - Behavioral Tests > Token Polling > should respect server-specified polling interval  10012ms
   ✓ QwenDeviceFlow - Behavioral Tests > Error Handling > should handle network failures with retry logic  18763ms

⎯⎯⎯⎯⎯⎯ Failed Tests 21 ⎯⎯⎯⎯⎯⎯⎯

 FAIL  src/core/geminiChat.contextlimit.test.ts > GeminiChat Context Limit Enforcement > should enforce context window using user-configured context-limit
TypeError: Cannot read properties of undefined (reading 'model')
 ❯ new GeminiChat src/core/geminiChat.ts:377:37
    375|     validateHistory(initialHistory);
    376| 
    377|     const model = this.runtimeState.model;
       |                                     ^
    378|     this.logger.debug('GeminiChat initialized:', {
    379|       model,
 ❯ src/core/geminiChat.contextlimit.test.ts:69:12

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[1/21]⎯

 FAIL  src/core/geminiChat.contextlimit.test.ts > GeminiChat Context Limit Enforcement > should not trigger compression when within context-limit
TypeError: Cannot read properties of undefined (reading 'model')
 ❯ new GeminiChat src/core/geminiChat.ts:377:37
    375|     validateHistory(initialHistory);
    376| 
    377|     const model = this.runtimeState.model;
       |                                     ^
    378|     this.logger.debug('GeminiChat initialized:', {
    379|       model,
 ❯ src/core/geminiChat.contextlimit.test.ts:89:12

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[2/21]⎯

 FAIL  src/core/geminiChat.contextlimit.test.ts > GeminiChat Context Limit Enforcement > should use context-limit when available, falling back to default when not set
TypeError: Cannot read properties of undefined (reading 'model')
 ❯ new GeminiChat src/core/geminiChat.ts:377:37
    375|     validateHistory(initialHistory);
    376| 
    377|     const model = this.runtimeState.model;
       |                                     ^
    378|     this.logger.debug('GeminiChat initialized:', {
    379|       model,
 ❯ src/core/geminiChat.contextlimit.test.ts:110:12

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[3/21]⎯

 FAIL  src/core/geminiChat.runtime.test.ts > GeminiChat runtime context > passes runtime context and tools to provider generateChatCompletion
Error: Request would exceed the 60000 token context window even after compression (projected 65539 tokens including system prompt and a 65536 token completion budget). Reduce earlier history or lower maxOutputTokens.
 ❯ GeminiChat.enforceContextWindow src/core/geminiChat.ts:1626:11

 ❯ GeminiChat.sendMessage src/core/geminiChat.ts:624:5
 ❯ src/core/geminiChat.runtime.test.ts:150:22

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[4/21]⎯

 FAIL  src/core/geminiChat.test.ts > GeminiChat > sendMessage > should call generateContent with the correct parameters
Error: Request would exceed the 60000 token context window even after compression (projected 65537 tokens including system prompt and a 65536 token completion budget). Reduce earlier history or lower maxOutputTokens.
 ❯ GeminiChat.enforceContextWindow src/core/geminiChat.ts:1626:11

 ❯ GeminiChat.sendMessage src/core/geminiChat.ts:624:5
 ❯ src/core/geminiChat.test.ts:194:7

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[5/21]⎯

 FAIL  src/core/geminiChat.test.ts > GeminiChat > sendMessage > should trigger compression when pending tokens exceed threshold
Error: Request would exceed the 60000 token context window even after compression (projected 130536 tokens including system prompt and a 65536 token completion budget). Reduce earlier history or lower maxOutputTokens.
 ❯ GeminiChat.enforceContextWindow src/core/geminiChat.ts:1626:11

 ❯ GeminiChat.sendMessage src/core/geminiChat.ts:624:5
 ❯ src/core/geminiChat.test.ts:240:7

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[6/21]⎯

 FAIL  src/core/geminiChat.test.ts > GeminiChat > sendMessage > should not trigger compression when pending tokens stay under threshold
Error: Request would exceed the 60000 token context window even after compression (projected 67036 tokens including system prompt and a 65536 token completion budget). Reduce earlier history or lower maxOutputTokens.
 ❯ GeminiChat.enforceContextWindow src/core/geminiChat.ts:1626:11

 ❯ GeminiChat.sendMessage src/core/geminiChat.ts:624:5
 ❯ src/core/geminiChat.test.ts:264:7

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[7/21]⎯

 FAIL  src/core/geminiChat.test.ts > GeminiChat > sendMessageStream > should call generateContentStream with the correct parameters
Error: Request would exceed the 60000 token context window even after compression (projected 65537 tokens including system prompt and a 65536 token completion budget). Reduce earlier history or lower maxOutputTokens.
 ❯ GeminiChat.enforceContextWindow src/core/geminiChat.ts:1626:11

 ❯ GeminiChat.makeApiCallAndProcessStream src/core/geminiChat.ts:1212:5
 ❯ src/core/geminiChat.ts:968:28
 ❯ src/core/geminiChat.test.ts:296:24

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[8/21]⎯

 FAIL  src/core/geminiChat.test.ts > GeminiChat > sendMessageStream with retries > should yield a RETRY event when an invalid stream is encountered
Error: Request would exceed the 60000 token context window even after compression (projected 65537 tokens including system prompt and a 65536 token completion budget). Reduce earlier history or lower maxOutputTokens.
 ❯ GeminiChat.enforceContextWindow src/core/geminiChat.ts:1626:11

 ❯ GeminiChat.makeApiCallAndProcessStream src/core/geminiChat.ts:1212:5
 ❯ src/core/geminiChat.ts:968:28
 ❯ src/core/geminiChat.test.ts:771:24

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[9/21]⎯

 FAIL  src/core/geminiChat.test.ts > GeminiChat > sendMessageStream with retries > should retry on invalid content and succeed on the second attempt
Error: Request would exceed the 60000 token context window even after compression (projected 65537 tokens including system prompt and a 65536 token completion budget). Reduce earlier history or lower maxOutputTokens.
 ❯ GeminiChat.enforceContextWindow src/core/geminiChat.ts:1626:11

 ❯ GeminiChat.makeApiCallAndProcessStream src/core/geminiChat.ts:1212:5
 ❯ src/core/geminiChat.ts:968:28
 ❯ src/core/geminiChat.test.ts:809:24

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[10/21]⎯

 FAIL  src/core/geminiChat.test.ts > GeminiChat > sendMessageStream with retries > should fail after all retries on persistent invalid content
AssertionError: expected error to be instance of EmptyStreamError

[32m- Expected:[39m 
[Function EmptyStreamError]

[31m+ Received:[39m 
Error {
  "message": "Request would exceed the 60000 token context window even after compression (projected 65537 tokens including system prompt and a 65536 token completion budget). Reduce earlier history or lower maxOutputTokens.",
}

 ❯ src/core/geminiChat.test.ts:863:7
    861|       }
    862| 
    863|       await expect(consumeStreamAndExpectError()).rejects.toThrow(
       |       ^
    864|         EmptyStreamError,
    865|       );

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[11/21]⎯

 FAIL  src/core/geminiChat.test.ts > GeminiChat > should correctly retry and append to an existing history mid-conversation
Error: Request would exceed the 60000 token context window even after compression (projected 65542 tokens including system prompt and a 65536 token completion budget). Reduce earlier history or lower maxOutputTokens.
 ❯ GeminiChat.enforceContextWindow src/core/geminiChat.ts:1626:11

 ❯ GeminiChat.makeApiCallAndProcessStream src/core/geminiChat.ts:1212:5
 ❯ src/core/geminiChat.ts:968:28
 ❯ src/core/geminiChat.test.ts:907:22

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[12/21]⎯

 FAIL  src/core/geminiChat.test.ts > GeminiChat > concurrency control > should queue a subsequent sendMessage call until the first one completes
AssertionError: expected "spy" to be called 1 times, but got 0 times
 ❯ src/core/geminiChat.test.ts:1008:51
    1006|       // 5. CRUCIAL CHECK: At this point, only the first API call shou…
    1007|       // The second call should be waiting on `sendPromise`.
    1008|       expect(mockProvider.generateChatCompletion).toHaveBeenCalledTime…
       |                                                   ^
    1009| 
    1010|       // 6. Unblock the first API call and wait for the first message …

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[13/21]⎯

 FAIL  src/core/geminiChat.test.ts > GeminiChat > should retry if the model returns a completely empty stream (no chunks)
Error: Request would exceed the 60000 token context window even after compression (projected 65539 tokens including system prompt and a 65536 token completion budget). Reduce earlier history or lower maxOutputTokens.
 ❯ GeminiChat.enforceContextWindow src/core/geminiChat.ts:1626:11

 ❯ GeminiChat.makeApiCallAndProcessStream src/core/geminiChat.ts:1212:5
 ❯ src/core/geminiChat.ts:968:28
 ❯ src/core/geminiChat.test.ts:1051:22

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[14/21]⎯

 FAIL  src/core/geminiChat.test.ts > GeminiChat > should queue a subsequent sendMessageStream call until the first stream is fully consumed
Error: Request would exceed the 60000 token context window even after compression (projected 65537 tokens including system prompt and a 65536 token completion budget). Reduce earlier history or lower maxOutputTokens.
 ❯ GeminiChat.enforceContextWindow src/core/geminiChat.ts:1626:11

 ❯ GeminiChat.makeApiCallAndProcessStream src/core/geminiChat.ts:1212:5
 ❯ src/core/geminiChat.ts:968:28
 ❯ src/core/geminiChat.test.ts:1121:5

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[15/21]⎯

 FAIL  src/core/geminiChat.test.ts > GeminiChat > should retry when all content is invalid and succeed on the second attempt
Error: Request would exceed the 60000 token context window even after compression (projected 65537 tokens including system prompt and a 65536 token completion budget). Reduce earlier history or lower maxOutputTokens.
 ❯ GeminiChat.enforceContextWindow src/core/geminiChat.ts:1626:11

 ❯ GeminiChat.makeApiCallAndProcessStream src/core/geminiChat.ts:1212:5
 ❯ src/core/geminiChat.ts:968:28
 ❯ src/core/geminiChat.test.ts:1195:22

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[16/21]⎯

 FAIL  src/core/geminiChat.test.ts > GeminiChat > normalizeToolInteractionInput > should handle flattened tool call/response arrays from UI
Error: Request would exceed the 60000 token context window even after compression (projected 65582 tokens including system prompt and a 65536 token completion budget). Reduce earlier history or lower maxOutputTokens.
 ❯ GeminiChat.enforceContextWindow src/core/geminiChat.ts:1626:11

 ❯ GeminiChat.makeApiCallAndProcessStream src/core/geminiChat.ts:1212:5
 ❯ src/core/geminiChat.ts:968:28
 ❯ src/core/geminiChat.test.ts:1266:24

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[17/21]⎯

 FAIL  src/core/geminiChat.test.ts > GeminiChat > normalizeToolInteractionInput > should handle single paired tool call/response (2 elements)
Error: Request would exceed the 60000 token context window even after compression (projected 65557 tokens including system prompt and a 65536 token completion budget). Reduce earlier history or lower maxOutputTokens.
 ❯ GeminiChat.enforceContextWindow src/core/geminiChat.ts:1626:11

 ❯ GeminiChat.makeApiCallAndProcessStream src/core/geminiChat.ts:1212:5
 ❯ src/core/geminiChat.ts:968:28
 ❯ src/core/geminiChat.test.ts:1342:24

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[18/21]⎯

 FAIL  src/core/geminiChat.test.ts > GeminiChat > stateless runtime context compliance > should not rely on global provider runtime context
AssertionError: promise rejected "Error: Request would exceed the 60000 tok…" instead of resolving
 ❯ src/core/geminiChat.test.ts:1379:7
    1377|       await expect(
    1378|         chat.sendMessage({ message: 'stateless-check' }, 'stateless-pr…
    1379|       ).resolves.toBeDefined();
       |       ^
    1380| 
    1381|       expect(getRuntimeSpy).not.toHaveBeenCalled();

Caused by: Error: Request would exceed the 60000 token context window even after compression (projected 65539 tokens including system prompt and a 65536 token completion budget). Reduce earlier history or lower maxOutputTokens.
 ❯ GeminiChat.enforceContextWindow src/core/geminiChat.ts:1626:11
 ❯ GeminiChat.sendMessage src/core/geminiChat.ts:624:5
 ❯ src/core/geminiChat.test.ts:1377:7

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[19/21]⎯

 FAIL  src/providers/ProviderManager.test.ts > ProviderManager provider ordering > prioritizes core providers and sorts remaining alphabetically
MissingProviderRuntimeError: MissingProviderRuntimeError(provider-runtime): runtime registration missing. Run activateIsolatedRuntimeContext() before invoking providers (REQ-SP4-004).
 ❯ getActiveProviderRuntimeContext src/runtime/providerRuntimeContext.ts:83:9
     81|   }
     82| 
     83|   throw new MissingProviderRuntimeError({
       |         ^
     84|     providerKey: 'provider-runtime',
     85|     missingFields: ['runtime registration'],
 ❯ ensureFallback src/providers/ProviderManager.ts:122:20
 ❯ ProviderManager.resolveInit src/providers/ProviderManager.ts:128:24
 ❯ new ProviderManager src/providers/ProviderManager.ts:98:27
 ❯ src/providers/ProviderManager.test.ts:34:21

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[20/21]⎯

 FAIL  src/providers/openai/OpenAIProvider.toolFormatDetection.test.ts > OpenAIProvider tool format detection > detects qwen format for GLM models
AssertionError: expected 'openai' to be 'qwen' // Object.is equality

Expected: [32m"qwen"[39m
Received: [31m"openai"[39m

 ❯ src/providers/openai/OpenAIProvider.toolFormatDetection.test.ts:34:38
     32|     vi.spyOn(provider, 'getModel').mockReturnValue('openai:hf:zai-org/…
     33| 
     34|     expect(provider.getToolFormat()).toBe('qwen');
       |                                      ^
     35|   });
     36| 

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[21/21]⎯

⎯⎯⎯⎯⎯⎯ Unhandled Errors ⎯⎯⎯⎯⎯⎯

Vitest caught 2 unhandled errors during the test run.
This might cause false positive tests. Resolve unhandled errors to make sure your tests are not affected.

⎯⎯⎯⎯ Unhandled Rejection ⎯⎯⎯⎯⎯
Error: Request would exceed the 60000 token context window even after compression (projected 65537 tokens including system prompt and a 65536 token completion budget). Reduce earlier history or lower maxOutputTokens.
 ❯ GeminiChat.enforceContextWindow src/core/geminiChat.ts:1626:11

 ❯ processTicksAndRejections node:internal/process/task_queues:105:5
 ❯ GeminiChat.sendMessage src/core/geminiChat.ts:624:5

This error originated in "src/core/geminiChat.test.ts" test file. It doesn't mean the error was thrown inside the file itself, but while it was running.

⎯⎯⎯⎯ Unhandled Rejection ⎯⎯⎯⎯⎯
Error: Request would exceed the 60000 token context window even after compression (projected 65537 tokens including system prompt and a 65536 token completion budget). Reduce earlier history or lower maxOutputTokens.
 ❯ GeminiChat.enforceContextWindow src/core/geminiChat.ts:1626:11

 ❯ processTicksAndRejections node:internal/process/task_queues:105:5
 ❯ GeminiChat.sendMessage src/core/geminiChat.ts:624:5

This error originated in "src/core/geminiChat.test.ts" test file. It doesn't mean the error was thrown inside the file itself, but while it was running.
⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯


 Test Files  5 failed | 209 passed | 7 skipped (221)
      Tests  21 failed | 3360 passed | 66 skipped (3447)
     Errors  2 errors
   Start at  14:48:56
   Duration  42.85s (transform 6.46s, setup 4.22s, collect 141.30s, tests 89.63s, environment 39ms, prepare 28.75s)

JUNIT report written to /Users/acoliver/projects/llxprt-code/packages/core/junit.xml
npm error Lifecycle script `test:ci` failed with error:
npm error code 1
npm error path /Users/acoliver/projects/llxprt-code/packages/core
npm error workspace @vybestack/llxprt-code-core@0.5.0
npm error location /Users/acoliver/projects/llxprt-code/packages/core
npm error command failed
npm error command sh -c vitest run --coverage


> llxprt-code-vscode-ide-companion@0.5.0 test:ci
> vitest run --coverage


 RUN  v3.2.4 /Users/acoliver/projects/llxprt-code/packages/vscode-ide-companion
      Coverage enabled with v8

 ✓ src/open-files-manager.test.ts (17 tests) 38ms
 ✓ src/extension.test.ts (4 tests) 9ms
 ✓ src/extension-multi-folder.test.ts (5 tests | 1 skipped) 15ms

 Test Files  3 passed (3)
      Tests  25 passed | 1 skipped (26)
   Start at  14:49:40
   Duration  939ms (transform 182ms, setup 0ms, collect 651ms, tests 62ms, environment 0ms, prepare 464ms)

 % Coverage report from v8
-------------------|---------|----------|---------|---------|-------------------
File               | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s 
-------------------|---------|----------|---------|---------|-------------------
All files          |   37.22 |       75 |    47.5 |   37.22 |                   
 ...-ide-companion |       0 |        0 |       0 |       0 |                   
  esbuild.js       |       0 |        0 |       0 |       0 | 1-69              
 ...panion/scripts |       0 |        0 |       0 |       0 |                   
  ...te-notices.js |       0 |        0 |       0 |       0 | 1-158             
 ...-companion/src |   44.81 |    78.18 |   48.64 |   44.81 |                   
  diff-manager.ts  |   23.15 |       75 |      20 |   23.15 | ...40-241,244-269 
  extension.ts     |   57.35 |       75 |      50 |   57.35 | ...33-137,142-156 
  ide-schemas.ts   |     100 |      100 |     100 |     100 |                   
  ide-server.ts    |   26.37 |       60 |      50 |   26.37 | ...62-377,389-408 
  ...es-manager.ts |   94.36 |    84.84 |     100 |   94.36 | ...85,143-144,151 
 ...nion/src/utils |   83.33 |    66.66 |     100 |   83.33 |                   
  logger.ts        |   83.33 |    66.66 |     100 |   83.33 | 15-16             
-------------------|---------|----------|---------|---------|-------------------
