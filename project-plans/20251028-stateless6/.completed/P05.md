# Phase P05: Pseudocode Runtime View - COMPLETED

> @plan PLAN-20251028-STATELESS6.P05

## Completion Date
2025-10-28

## Deliverables

### Primary Output
- `/Users/acoliver/projects/llxprt-code/project-plans/20251028-stateless6/analysis/pseudocode/agent-runtime-context.md`

## Completion Criteria Verification

### ✅ Pseudocode Structure (Steps 001-010)
- **001-004**: Interface definitions (ReadonlySettingsSnapshot, ToolRegistryView, AgentRuntimeContext, AgentRuntimeContextFactoryOptions)
- **005**: Builder function `createAgentRuntimeContext(options)` with 6 substeps
- **006**: GeminiChat refactor pseudocode with 7 substeps
- **007**: SubAgentScope refactor pseudocode with 8 substeps
- **008**: Config compatibility adapter (migration aid)
- **009**: Edge case handling (5 scenarios)
- **010**: Traceability & phase mapping

### ✅ Requirements Cross-Referenced
All 9 requirements referenced within pseudocode comments:
- REQ-STAT6-001.1: Factory construction (steps 005, 007.2-007.6, 008)
- REQ-STAT6-001.2: GeminiChat Config elimination (steps 006.1-006.7)
- REQ-STAT6-001.3: Immutability enforcement (steps 005.6, 009.1)
- REQ-STAT6-002.1: Runtime state data (step 003)
- REQ-STAT6-002.2: Ephemeral settings (steps 001, 003, 005.2, 006.3, 009.3)
- REQ-STAT6-002.3: Telemetry integration (steps 003, 005.4, 006.5)
- REQ-STAT6-003.1: Config isolation (steps 007.8, 008, 009.1)
- REQ-STAT6-003.2: History isolation (steps 005.1, 007.4, 009.2)
- REQ-STAT6-003.3: Telemetry runtime correlation (step 005.4)

### ✅ Phase Mapping Documented
Step ranges mapped to implementation phases:
- **Steps 001-005, 008-009** → **P06 (Stub Implementation)**
  - Interface definitions and factory scaffolding
  - Edge case handling
  - Config compatibility adapter
- **Step 006** → **P08 (GeminiChat Unit Implementation)**
  - Constructor signature change
  - Ephemeral settings migration
  - Provider/tool/telemetry adapter integration
  - Config field elimination
- **Step 007** → **P07 (SubAgentScope Integration)**
  - Constructor signature change
  - Direct runtime state construction
  - Config mutation elimination (CRITICAL for REQ-STAT6-003.1)

### ✅ Immutability Enforcement
- Step 005.6: `Object.freeze()` applied to runtime context
- Step 009.1: Provider adapter throws on mutation attempts

### ✅ TDD Detail Level
Pseudocode provides sufficient detail for test-driven development:
- Interface contracts specified (001-004)
- Factory implementation logic detailed (005.1-005.6)
- Migration patterns documented (006, 007)
- Edge cases enumerated (009.1-009.5)
- Traceability to requirements and phases (010)

### ✅ @plan Annotations
- Present at line 3: `> @plan PLAN-20251028-STATELESS6.P05`

## Key Pseudocode Sections Summary

### 1. Core Interfaces (Steps 001-004)
- **ReadonlySettingsSnapshot**: Ephemeral settings snapshot (compression thresholds, context limits, telemetry config)
- **ToolRegistryView**: Read-only tool registry interface
- **AgentRuntimeContext**: Immutable runtime view with state, history, ephemerals, telemetry, provider, and tools
- **AgentRuntimeContextFactoryOptions**: Factory input structure

### 2. Factory Builder (Step 005)
Creates immutable runtime contexts with:
- Isolated history service (005.1)
- Ephemeral settings with defaults (005.2)
- Provider adapter (mutable for foreground, read-only for subagents) (005.3)
- Telemetry adapter with metadata enrichment (005.4)
- Tool registry view (005.5)
- Immutability guarantee via `Object.freeze()` (005.6)

### 3. GeminiChat Refactor (Step 006)
7 substeps for eliminating 20 Config touchpoints:
- Constructor signature change to accept `AgentRuntimeContext`
- Replace `config.getEphemeralSetting()` with `view.ephemerals`
- Replace `config.getProviderManager()` with `view.provider`
- Replace `logApiRequest(config, ...)` with `view.telemetry.logApiRequest(...)`
- Replace `config.getToolRegistry()` with `view.tools`
- Remove `this.config` field

### 4. SubAgentScope Refactor (Step 007)
8 substeps for achieving Config isolation:
- Constructor signature change
- Direct `AgentRuntimeState` construction from subagent profile
- Build `ReadonlySettingsSnapshot` from profile
- Call `createAgentRuntimeContext()` for isolated runtime view
- Content generator initialization with runtime context adapter
- **CRITICAL**: Remove `this.runtimeContext.setModel()` mutation (007.8)

### 5. Edge Cases & Safety (Step 009)
- Read-only provider adapter throws on `setActiveProvider()`
- Isolated history service per context
- Ephemeral getters fallback to defaults
- Telemetry no-op when disabled
- Tool registry gracefully handles missing registry

## Next Steps
Phase P06: Stub Implementation
- Implement interface definitions (steps 001-004)
- Scaffold `createAgentRuntimeContext()` factory (step 005)
- Create Config compatibility adapter (step 008)
- Add edge case handling (step 009)
- Write unit tests for immutability and adapter contracts

## Dependencies Satisfied
- ✅ P02a: Architecture analysis complete (27 Config touchpoints identified)
- ✅ P03a: Integration map complete (5 adapter interfaces defined)
- ✅ P04a: Requirements and test strategy complete (9 requirements, 55 test cases)

## Artifacts Modified
- Enhanced `/Users/acoliver/projects/llxprt-code/project-plans/20251028-stateless6/analysis/pseudocode/agent-runtime-context.md` with:
  - Explicit phase mapping (P06, P07, P08)
  - Requirements traceability matrix
  - Step-to-requirement cross-reference
