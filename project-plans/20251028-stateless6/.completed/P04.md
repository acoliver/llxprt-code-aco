# Phase P04 Completion: Requirements & Test Strategy

> @plan PLAN-20251028-STATELESS6.P04

## Completion Date
2025-10-28

## Prerequisites Verified
- [x] P02a completion marker exists
- [x] P03a completion marker exists

## Artifacts Updated

### 1. Requirements Document (`requirements.md`)
- **Lines Modified**: Complete rewrite from 19 lines to 227 lines
- **Key Additions**:
  - Hierarchical requirement structure with 3 top-level and 9 sub-requirements
  - Phase mapping for each requirement (P06-P10)
  - P03 cross-references to 27 Config touchpoints and line 609 mutation
  - Acceptance criteria per sub-requirement
  - Requirements traceability matrix
  - Phase mapping summary

**Structure**:
- REQ-STAT6-001: Stateless Runtime View Injection (3 sub-requirements)
  - REQ-STAT6-001.1: AgentRuntimeContext Construction (P06, P07)
  - REQ-STAT6-001.2: GeminiChat Config Elimination (P08, P09)
  - REQ-STAT6-001.3: Immutability Enforcement (P06, P10)
- REQ-STAT6-002: Runtime Data Completeness (3 sub-requirements)
  - REQ-STAT6-002.1: Core Runtime State Data (P06, P09)
  - REQ-STAT6-002.2: Ephemeral Settings Access (P06, P08)
  - REQ-STAT6-002.3: Telemetry Integration (P06, P08, P09)
- REQ-STAT6-003: Isolation & Concurrency (3 sub-requirements)
  - REQ-STAT6-003.1: Foreground Config Immutability (P07, P09)
  - REQ-STAT6-003.2: History Service Isolation (P07, P09)
  - REQ-STAT6-003.3: Telemetry Runtime Correlation (P08, P09)

### 2. Test Strategy Document (`test-strategy.md`)
- **Lines Modified**: Expanded from 134 lines to 781 lines
- **Key Additions**:
  - Unit test specifications for P06 (factory, ephemerals, telemetry, provider adapter)
  - Unit test specifications for P07 (SubAgentScope config mutation prevention, history isolation)
  - Unit test specifications for P08 (GeminiChat config elimination, compression, telemetry, tools)
  - Integration test specifications for P09 (foreground immutability, concurrent isolation, telemetry correlation)
  - Mutation testing targets for P10 (immutability enforcement, regression guards)
  - Property-based test specifications (6 tests identified, target ≥30% = 11 more needed)
  - Test coverage matrix (55 total tests planned)
  - Verification checklist per phase

**Test Case Breakdown**:
- **Unit Tests**: 28 tests across P06-P08
  - P06 Scaffold: 11 tests (factory, ephemerals, telemetry, provider)
  - P07 SubAgentScope: 8 tests (mutation prevention, history isolation)
  - P08 GeminiChat: 9 tests (config elimination, adapters)
- **Integration Tests**: 10 tests in P09
  - Foreground model immutability
  - Concurrent execution isolation
  - History isolation
  - Telemetry runtime ID correlation
  - Provider adapter isolation
- **Property-Based Tests**: 6 tests (need 11 more for ≥30%)
  - Round-trip compression thresholds
  - Telemetry enrichment properties
  - Immutability properties
- **Mutation Tests**: 11 tests in P10
  - Critical mutation targets (freeze removal, default changes, enrichment removal)
  - Spy-based regression guards
  - Expected kill rate: ≥80%

## Cross-References Documented

### P03 Analysis Mappings
1. **27 Config Touchpoints**:
   - GeminiChat: 20 touchpoints mapped to REQ-STAT6-001.2
   - SubAgentScope: 7 touchpoints mapped to REQ-STAT6-001.1, REQ-STAT6-003.1

2. **Line 609 Mutation**:
   - `this.runtimeContext.setModel()` → REQ-STAT6-003.1 (critical regression risk)
   - Test strategy includes 5 spy-based tests to prevent this mutation

3. **5 Adapter Interfaces**:
   - Provider Adapter → REQ-STAT6-002.1
   - Settings Adapter → REQ-STAT6-002.1
   - Ephemeral Settings → REQ-STAT6-002.2
   - Telemetry Target → REQ-STAT6-002.3
   - Tool Adapter → REQ-STAT6-001.2

### Architecture.md References
- Section "STATELESS5 Outcomes" (lines 6-15) → REQ-STAT6-002.1
- Section "GeminiChat Config Dependencies" (lines 88-189) → REQ-STAT6-001.2
- Section "SubAgentScope Config Dependencies" (lines 200-206) → REQ-STAT6-003.1
- Section "Supporting Observations" #2 (immutability) → REQ-STAT6-001.3
- Section "Supporting Observations" #4 (constructor signature) → REQ-STAT6-001.1

### Integration-Map.md References
- Component Dependency Mapping (lines 8-21) → All REQ-STAT6-001 sub-requirements
- Ephemeral Settings Interface (lines 100-137) → REQ-STAT6-002.2
- Telemetry Target Interface (lines 142-197) → REQ-STAT6-002.3
- Subagent Constructor Signature Change (lines 239-299) → REQ-STAT6-001.1, REQ-STAT6-003.1

## Completion Criteria Met

- [x] Requirements document maps sub-requirements to phases P06-P12
- [x] Test strategy lists explicit unit/integration cases (55 total tests)
- [x] Mutation detection plan documented (P10 section, ≥80% kill rate target)
- [x] Both documents annotated with P04 markers (`@plan PLAN-20251028-STATELESS6.P04`)
- [x] Requirements traceability matrix links requirements → phases → tests
- [x] Test coverage matrix quantifies unit/integration/property/mutation tests per requirement
- [x] Verification checklist defines phase-specific acceptance criteria

## Key Insights & Decisions

### Requirement Decomposition
- 3 top-level requirements decomposed into 9 sub-requirements
- Each sub-requirement maps to 1-3 implementation phases
- Acceptance criteria define verifiable outcomes per sub-requirement

### Test Strategy Rationale
1. **Spy-Based Guards**: Critical for REQ-STAT6-003.1 (Config mutation prevention)
   - 5 tests spy on `setModel()`, `setProvider()`, `setContentGeneratorConfig()`
   - Tests fail if any mutator called during subagent lifecycle

2. **Property-Based Coverage**: Currently 10.9%, target ≥30%
   - Need 11 additional property tests in P06-P08
   - Focus areas: ephemeral settings, telemetry enrichment, immutability

3. **Mutation Testing**: P10 phase dedicated to mutation detection
   - Critical mutations: freeze removal, default changes, enrichment removal
   - Expected kill rate ≥80% on critical paths (factory, adapters, SubAgentScope.create)

4. **Integration Tests**: 10 tests in P09 verify end-to-end isolation
   - Foreground/subagent concurrent execution
   - Telemetry runtime ID correlation
   - History service isolation

### Phase Mapping Highlights
- **P06 (Scaffold)**: 5 requirements, 11 unit tests (factory, adapters)
- **P07 (SubAgentScope)**: 3 requirements, 8 unit tests (mutation prevention)
- **P08 (GeminiChat)**: 4 requirements, 9 unit tests (config elimination)
- **P09 (Integration)**: All 9 requirements, 10 integration tests
- **P10 (Mutation)**: REQ-STAT6-001.3 focus, 11 mutation tests

## Next Steps (Phase P04a)

The verification phase (P04a) should:
1. Review requirements traceability matrix for completeness
2. Verify all 27 Config touchpoints mapped to requirements
3. Confirm test strategy covers all acceptance criteria
4. Validate phase mapping aligns with plan.md dependencies
5. Check property-based test coverage plan (need 11 more tests)
6. Verify mutation testing targets align with critical paths

## Files Modified
1. `/Users/acoliver/projects/llxprt-code/project-plans/20251028-stateless6/requirements.md` (expanded 19 → 227 lines)
2. `/Users/acoliver/projects/llxprt-code/project-plans/20251028-stateless6/test-strategy.md` (expanded 134 → 781 lines)

## Annotations Applied
All sections in both documents include:
- `@plan PLAN-20251028-STATELESS6.P04` markers
- `@requirement REQ-STAT6-*` cross-references in test cases
- Phase-specific markers (`@plan PLAN-20251028-STATELESS6.P06`, etc.) in test specifications
