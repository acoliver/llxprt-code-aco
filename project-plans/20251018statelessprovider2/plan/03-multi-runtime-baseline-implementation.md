# Phase 03: Multi-Runtime Baseline Implementation

## Phase ID

`PLAN-20251018-STATELESSPROVIDER2.P03`

## Prerequisites

- Required: Phase 02a completed
- Verification: `grep -r "@plan:PLAN-20251018-STATELESSPROVIDER2.P02a" project-plans/20251018statelessprovider2/.completed`
- Expected files from previous phase:
  - Failing multi-runtime integration tests

## Implementation Tasks

### Files to Create

- `project-plans/20251018statelessprovider2/analysis/pseudocode/multi-runtime-baseline.md`  
  - Outline algorithm for constructing isolated CLI runtimes with independent `SettingsService`, `Config`, and `ProviderManager` instances  
  - Enumerate cleanup steps after each run  
  - Each major step MUST be numbered for cross-reference  
  - Include `@plan:PLAN-20251018-STATELESSPROVIDER2.P03` and `@requirement:REQ-SP2-002`

- `packages/cli/src/runtime/runtimeContextFactory.ts` â€“ New helper module exporting `createIsolatedRuntimeContext` used by tests and (eventually) CLI  
  - Implement according to pseudocode lines  
  - Expose cleanup utility to dispose managers/settings after use

### Files to Modify

- `packages/cli/src/integration-tests/provider-multi-runtime.integration.test.ts`  
  - Replace ad-hoc setup with `createIsolatedRuntimeContext` helper  
  - Ensure tests now PASS using isolated contexts  
  - Reference pseudocode line numbers in comments

- `packages/cli/src/runtime/runtimeSettings.ts`  
  - Export new factory function or re-export from `runtimeContextFactory.ts` for broader use  
  - Guard legacy singleton paths behind explicit opt-in comments  
  - NOTE: factories MUST reuse shared immutable Config resources (e.g., file services) when safe, avoiding heavy I/O on every invocation. Document reuse strategy inline referencing pseudocode.

- `packages/core/src/providers/ProviderManager.ts`  
  - Ensure constructor accepts runtime context generated by factory without relying on global singletons  
  - Reference pseudocode lines detailing initialization order

### Required Code Markers

Every new helper/function MUST include:

```typescript
/**
 * @plan PLAN-20251018-STATELESSPROVIDER2.P03
 * @requirement REQ-SP2-002
 * @pseudocode multi-runtime-baseline.md lines X-Y
 */
```

## Verification Commands

### Automated Checks

```bash
# Verify plan markers and pseudocode references
grep -r "@plan:PLAN-20251018-STATELESSPROVIDER2.P03" packages/cli/src/runtime runtimeSettings.ts packages/core/src/providers/ProviderManager.ts

# Run targeted suite (MUST PASS)
npm run test:multi-runtime
```

### Manual Verification Checklist

- [ ] Pseudocode document created and referenced in implementation
- [ ] Multi-runtime integration tests now pass
- [ ] Helper factory returns isolated contexts (validated within tests)
- [ ] ProviderManager initialization no longer relies on global singleton

## Success Criteria

- Multi-runtime tests pass without modifying assertions
- Implementation strictly follows documented pseudocode
- No warnings about shared state remain in test logs

## Failure Recovery

1. Revert touched files:  
   `git checkout -- packages/cli/src/runtime/runtimeContextFactory.ts packages/cli/src/integration-tests/provider-multi-runtime.integration.test.ts packages/cli/src/runtime/runtimeSettings.ts packages/core/src/providers/ProviderManager.ts`
2. Delete pseudocode file if incorrect
3. Re-run phase

## Phase Completion Marker

Create: `project-plans/20251018statelessprovider2/.completed/P03.md`

```markdown
Phase: P03
Completed: YYYY-MM-DD HH:MM
Files Created:
- project-plans/20251018statelessprovider2/analysis/pseudocode/multi-runtime-baseline.md
- packages/cli/src/runtime/runtimeContextFactory.ts
Files Modified:
- packages/cli/src/integration-tests/provider-multi-runtime.integration.test.ts
- packages/cli/src/runtime/runtimeSettings.ts
- packages/core/src/providers/ProviderManager.ts
Verification:
- <paste command outputs>
```
