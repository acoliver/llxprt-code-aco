
 RUN  v3.2.4 /Users/acoliver/projects/llxprt-code

 ❯ packages/core/src/core/geminiChat.test.ts (34 tests | 1 failed) 6836ms
   ✓ GeminiChat > sendMessage > should call generateContent with the correct parameters 93ms
   ✓ GeminiChat > sendMessage > should trigger compression when pending tokens exceed threshold 64ms
   ✓ GeminiChat > sendMessage > should not trigger compression when pending tokens stay under threshold 62ms
   ✓ GeminiChat > sendMessageStream > should call generateContentStream with the correct parameters 72ms
   ✓ GeminiChat > recordHistory > should add user input and a single model output to history 75ms
   ✓ GeminiChat > recordHistory > should consolidate adjacent model outputs 74ms
   ✓ GeminiChat > recordHistory > should handle a mix of user and model roles in outputContents (though unusual) 72ms
   ✓ GeminiChat > recordHistory > should consolidate multiple adjacent model outputs correctly 76ms
   ✓ GeminiChat > recordHistory > should not consolidate if roles are different between model outputs 75ms
   ✓ GeminiChat > recordHistory > should merge with last history entry if it is also a model output 153ms
   ✓ GeminiChat > recordHistory > should correctly merge consolidated new output with existing model history 75ms
   ✓ GeminiChat > recordHistory > should handle empty modelOutput array 79ms
   ✓ GeminiChat > recordHistory > should handle aggregating modelOutput 77ms
   ✓ GeminiChat > recordHistory > should handle modelOutput with parts being undefined or empty (if they pass initial every check) 84ms
   ✓ GeminiChat > recordHistory > should correctly handle automaticFunctionCallingHistory 81ms
   ✓ GeminiChat > recordHistory > should add userInput if AFC history is present but empty 77ms
   ✓ GeminiChat > recordHistory > should skip "thought" content from modelOutput 81ms
   ✓ GeminiChat > recordHistory > should skip "thought" content even if it is the only content 83ms
   ✓ GeminiChat > recordHistory > should correctly consolidate text parts when a thought part is in between 84ms
   ✓ GeminiChat > recordHistory > should handle multiple thought parts correctly 111ms
   ✓ GeminiChat > recordHistory > should handle thought part at the end of outputContents 91ms
   ✓ GeminiChat > addHistory > should add a new content item to the history 114ms
   ✓ GeminiChat > addHistory > should add multiple items correctly 180ms
   ✓ GeminiChat > sendMessageStream with retries > should yield a RETRY event when an invalid stream is encountered  658ms
   ✓ GeminiChat > sendMessageStream with retries > should retry on invalid content and succeed on the second attempt  565ms
   ✓ GeminiChat > sendMessageStream with retries > should fail after all retries on persistent invalid content  1568ms
   ✓ GeminiChat > should correctly retry and append to an existing history mid-conversation  562ms
   ✓ GeminiChat > concurrency control > should queue a subsequent sendMessage call until the first one completes 69ms
   ✓ GeminiChat > should retry if the model returns a completely empty stream (no chunks)  568ms
   ✓ GeminiChat > should queue a subsequent sendMessageStream call until the first stream is fully consumed 61ms
   ✓ GeminiChat > should retry when all content is invalid and succeed on the second attempt  562ms
   ✓ GeminiChat > normalizeToolInteractionInput > should handle flattened tool call/response arrays from UI 61ms
   ✓ GeminiChat > normalizeToolInteractionInput > should handle single paired tool call/response (2 elements) 60ms
   × GeminiChat > stateless runtime context compliance > should not rely on global provider runtime context 68ms
     → promise rejected "Error: REGRESSION: GeminiChat accessed gl…" instead of resolving

⎯⎯⎯⎯⎯⎯⎯ Failed Tests 1 ⎯⎯⎯⎯⎯⎯⎯

 FAIL  packages/core/src/core/geminiChat.test.ts > GeminiChat > stateless runtime context compliance > should not rely on global provider runtime context
AssertionError: promise rejected "Error: REGRESSION: GeminiChat accessed gl…" instead of resolving
 ❯ packages/core/src/core/geminiChat.test.ts:1362:7
    1360|       await expect(
    1361|         chat.sendMessage({ message: 'stateless-check' }, 'stateless-pr…
    1362|       ).resolves.toBeDefined();
       |       ^
    1363| 
    1364|       expect(getRuntimeSpy).not.toHaveBeenCalled();

Caused by: Error: REGRESSION: GeminiChat accessed global provider runtime context
 ❯ packages/core/src/core/geminiChat.test.ts:1355:17
 ❯ apiCall packages/core/src/core/geminiChat.ts:706:31
 ❯ retryWithBackoff packages/core/src/utils/retry.ts:269:20
 ❯ GeminiChat.sendMessage packages/core/src/core/geminiChat.ts:747:24
 ❯ packages/core/src/core/geminiChat.test.ts:1360:7

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[1/1]⎯


 Test Files  1 failed (1)
      Tests  1 failed | 33 passed (34)
   Start at  11:49:56
   Duration  8.49s (transform 645ms, setup 0ms, collect 1.32s, tests 6.84s, environment 0ms, prepare 69ms)

